# 数据备份与迁移 (Volumes)

## 适用场景
- 数据库迁移：把 MySQL 的数据卷从开发机迁移到生产机。
- 灾难备份：定期备份重要的 Docker Volume。
- **注意**：如果是 Bind Mount (直接挂载宿主机目录)，直接用 `cp` 或 `rsync` 复制宿主机文件夹即可，不需要看本文。本文主要针对 **Docker Volume**。

## 1. 备份 Volume
Docker Volume 的数据在 `/var/lib/docker/volumes` 下，直接拷贝可能涉及权限问题。
**标准做法**：启动一个临时容器，挂载该 Volume，然后打包压缩。

### 通用备份命令模板
假设我们要备份名为 `my-db-data` 的卷：

```bash
docker run --rm \
  # 1. 挂载要备份的卷到 /volume
  -v my-db-data:/volume \
  # 2. 挂载当前目录到 /backup (用于存放备份文件)
  -v $(pwd):/backup \
  # 3. 使用轻量级镜像 (alpine/ubuntu)
  ubuntu \
  # 4. 执行打包命令
  tar cvf /backup/backup.tar /volume
```

**解释**：
- `--rm`: 任务跑完自动删除临时容器。
- `tar cvf`: 将 `/volume` (即数据卷内容) 打包成 `/backup/backup.tar` (即宿主机当前目录下的文件)。

## 2. 恢复 Volume
将备份的 `backup.tar` 恢复到一个新的卷 `new-db-data` 中。

### 步骤 1：创建新卷
```bash
docker volume create new-db-data
```

### 步骤 2：解压恢复
```bash
docker run --rm \
  # 1. 挂载新卷
  -v new-db-data:/volume \
  # 2. 挂载备份文件所在目录
  -v $(pwd):/backup \
  ubuntu \
  # 3. 解压命令 (注意 -C 指定解压路径)
  bash -c "cd /volume && tar xvf /backup/backup.tar --strip-components=1"
```

> [!WARNING] 注意路径层级
> `tar` 打包时如果包含了绝对路径，解压时可能需要 `--strip-components` 参数来去掉顶层目录，否则数据可能会变成 `/volume/volume/xxx`。建议先在容器里 `ls` 确认一下。

## 3. 跨主机迁移
如果你想把 Volume 从机器 A 传到机器 B：

1. **机器 A**: 执行备份命令，得到 `backup.tar`。
2. **传输**: `scp backup.tar user@machine-B:/tmp/`。
3. **机器 B**: 执行恢复命令，将数据导入新卷。

## 4. 简单粗暴法 (仅限 Linux)
如果你有 root 权限，且 Docker 服务已停止（防止数据损坏）：
直接去 `/var/lib/docker/volumes/` 目录下打包对应的文件夹即可。
*不推荐用于生产环境，因为可能导致文件权限错乱。*

