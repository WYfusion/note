# 敏感信息管理 (Secrets / ENV 风险)

## 适用场景
- 避免数据库密码、API Key、AWS Token 等敏感信息泄露。
- 防止敏感信息被 `docker history` 或 `docker inspect` 查看到。

## 1. 环境变量的风险点
最常见的做法是使用 `-e PASSWORD=123`，但这非常不安全。

- **风险 1**: `docker inspect container_id` 可以直接看到明文密码。
- **风险 2**: 某些应用崩溃时，会将环境变量打印到日志中。
- **风险 3**: 如果在 `Dockerfile` 中使用 `ENV PASSWORD=123`，这个密码会永久保存在镜像层中，任何人 `pull` 下来都能看到。

## 2. 解决方案 A: Docker Compose Secrets (推荐)
Docker Compose 支持 Secrets 管理，将密码作为文件挂载到容器内 `/run/secrets/` 下。

**compose.yaml**:
```yaml
services:
  db:
    image: postgres
    environment:
      # 告诉 Postgres 从文件读取密码 (很多官方镜像支持 _FILE 后缀)
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password

secrets:
  db_password:
    file: ./secrets/db_password.txt  # 本地的一个文件，内容是密码
```
*注意：`./secrets/db_password.txt` 应该被加入 `.gitignore`。*

## 3. 解决方案 B: BuildKit Secrets (构建时)
如果在 `docker build` 期间需要 SSH Key 或 Token（例如拉取私有代码库），不要用 `ARG` 或 `COPY`。

**Dockerfile**:
```dockerfile
# 挂载 secret 到指定位置，仅在 RUN 指令执行期间可见，不会留在镜像层
RUN --mount=type=secret,id=mytoken \
    cat /run/secrets/mytoken && \
    pip install --index-url https://$(cat /run/secrets/mytoken)@pypi.company.com/simple my-package
```

**构建命令**:
```bash
docker build --secret id=mytoken,src=./token.txt .
```

## 4. `.env` 文件与版本控制
- **`.env`**: 用于存放非敏感的配置（如端口号、镜像版本）。
- **`.env.local` / `.env.prod`**: 存放敏感信息，**必须加入 `.gitignore`**。
- **最佳实践**: 提供一个 `.env.example` 模板文件，不包含真实值。


## TODO
- [ ] 敏感信息检查清单
