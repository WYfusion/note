# 深度学习容器启动模板

## 适用场景
- 复制粘贴即用的“黄金命令”。
- 解决常见痛点：显存不足、共享内存不足、端口映射、文件挂载。

## 1. 黄金启动命令 (Linux/Bash)

```bash
docker run -d \
  --name dl-lab \
  --restart unless-stopped \
  --gpus all \
  --shm-size=16g \
  -p 8888:8888 \
  -p 6006:6006 \
  -v $(pwd)/workspace:/workspace \
  -v /data/datasets:/data:ro \
  -e JUPYTER_TOKEN=mysecret \
  pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime \
  jupyter lab --ip=0.0.0.0 --allow-root --no-browser
```

## 2. 黄金启动命令 (Windows PowerShell)

```powershell
docker run -d `
  --name dl-lab `
  --restart unless-stopped `
  --gpus all `
  --shm-size=8g `
  -p 8888:8888 `
  -p 6006:6006 `
  -v "${PWD}/workspace:/workspace" `
  -v "D:\Datasets:/data:ro" `
  -e JUPYTER_TOKEN=mysecret `
  pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime `
  jupyter lab --ip=0.0.0.0 --allow-root --no-browser
```

## 3. 参数逐行解析 (为什么这么写？)

| 参数 | 作用 | 深度学习场景理由 |
| :--- | :--- | :--- |
| `--gpus all` | 启用所有 GPU | **必须**。否则 `torch.cuda.is_available()` 为 False。 |
| `--shm-size=16g` | 设置共享内存大小 | **必须**。默认 64MB 太小，PyTorch `DataLoader` 多进程读取数据时会报 `Bus error`。 |
| `-v ...:/data:ro` | 挂载数据集 (只读) | 防止代码误删 ImageNet 这种几百 G 的数据。 |
| `--restart unless-stopped` | 自动重启 | 宿主机重启后，开发环境自动拉起，不用手动去 start。 |
| `-p 8888:8888` | 映射 Jupyter 端口 | 浏览器访问 `localhost:8888`。 |
| `-p 6006:6006` | 映射 TensorBoard 端口 | 浏览器访问 `localhost:6006`。 |

## 4. 进阶技巧：用户权限映射
默认容器内是 `root`，生成的文件在宿主机上也是 `root` 权限，导致你无法修改。
**解决方案**：在启动时指定当前用户 ID。

```bash
# Linux 下
docker run -u $(id -u):$(id -g) ...
```
*注意：这需要镜像内已创建对应用户，或者使用支持任意 UID 的镜像。官方 PyTorch 镜像默认是 root，直接用 `-u` 可能会导致无法写入 `/workspace`，需要配合 Dockerfile 修改权限。*


## TODO
- [ ] 给出 2-3 个可复用模板（bash/pwsh）
