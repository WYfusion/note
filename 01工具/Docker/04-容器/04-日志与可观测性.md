# 日志与可观测性

## 适用场景
- **实时监控**：查看训练 Loss 曲线、进度条。
- **故障排查**：容器启动失败，查看报错堆栈。
- **磁盘保护**：防止训练日志（尤其是 tqdm 进度条）无限增长占满磁盘。

## 1. 查看日志 (`docker logs`)
Docker 默认捕获容器内 PID 1 进程的 `STDOUT` (标准输出) 和 `STDERR` (标准错误)。

```bash
docker logs [options] <container_id>
```

| 参数 | 作用 | 场景 |
| :--- | :--- | :--- |
| `-f` / `--follow` | 实时跟踪日志输出 (类似 `tail -f`) | 监控正在运行的训练任务。 |
| `--tail <n>` | 仅显示最后 n 行 | 日志太长，只想看最新的报错。 |
| `-t` / `--timestamps` | 显示时间戳 | 分析代码执行耗时。 |
| `--since <time>` | 显示指定时间后的日志 | `30m` (30分钟前), `2023-01-01`。 |

#### 示例
```bash
# 实时查看最后 100 行日志
docker logs -f --tail 100 my_training_job
```

## 2. 日志轮转 (Log Rotation)
**这是深度学习用户常忽略的隐患。**
默认情况下，Docker 使用 `json-file` 驱动，**不限制日志文件大小**。
如果你的训练代码使用 `tqdm` 打印进度条，或者频繁 `print` Loss，跑一周下来，`/var/lib/docker/containers/.../*.log` 可能膨胀到 100GB+，导致宿主机磁盘爆满。

#### 解决方案 A：全局配置 (推荐)
修改 `/etc/docker/daemon.json`，设置默认轮转策略：
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
```
*含义：每个容器最多保留 3 个日志文件，每个最大 100MB。*
修改后需重启 Docker：`systemctl restart docker`。

#### 解决方案 B：单容器配置
在 `docker run` 时指定：
```bash
docker run -d \
  --log-opt max-size=50m \
  --log-opt max-file=1 \
  my_image
```

## 3. 资源监控 (`docker stats`)
查看容器实时的 CPU、内存、网络 I/O 使用情况。

```bash
docker stats
```

输出示例：
```text
CONTAINER ID   NAME      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O
a1b2c3d4e5f6   train_1   150.00%   12.5GiB / 32.0GiB     39.06%    1.2GB / 500MB
```

> [!NOTE] 关于 GPU 监控
> `docker stats` **不显示 GPU 使用率**。
> 监控 GPU 仍需在宿主机或容器内使用 `nvidia-smi` 或 `nvtop`。

## 4. 查看进程 (`docker top`)
查看容器内部运行的进程信息（在宿主机视角）。

```bash
docker top <container_id>
```
这在排查僵尸进程或确认多进程 DataLoader 是否正常启动时很有用。

