# 资源限制与隔离

## 适用场景
- **多卡服务器共享**：指定特定 GPU 给特定容器，避免冲突。
- **防止整机崩溃**：限制单容器内存，防止代码 Bug 耗尽宿主机 128GB 内存导致死机。
- **性能调优**：解决 PyTorch `DataLoader` 报错 "Bus error" 的问题。

## 1. GPU 资源 (`--gpus`)
这是深度学习容器最核心的参数。需要宿主机安装 NVIDIA Driver 和 NVIDIA Container Toolkit。

| 参数格式 | 含义 | 示例 |
| :--- | :--- | :--- |
| `all` | 使用宿主机所有 GPU | `--gpus all` |
| `device=<id>` | 指定特定 GPU ID (逗号分隔) | `--gpus "device=0,2"` |
| `count=<n>` | 随机分配 n 个 GPU | `--gpus count=2` |

#### 示例
```bash
# 只使用 0 号和 1 号卡
docker run --gpus "device=0,1" ...

# 验证容器内能否看到 GPU
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi
```

> [!WARNING] 注意
> 如果不加 `--gpus` 参数，容器内将无法使用 CUDA，`torch.cuda.is_available()` 会返回 `False`。

## 2. 共享内存 (`--shm-size`)
**这是 PyTorch 用户最常遇到的坑。**
Docker 默认 `/dev/shm` 只有 64MB。而 PyTorch 的 `DataLoader` 使用共享内存进行多进程数据加载（`num_workers > 0`）。如果空间不足，程序会直接崩溃报错 `Bus error`。

#### 解决方案
1. **指定大小 (推荐)**：根据数据量大小，通常给 8G 或 16G 足够。
   ```bash
   docker run --shm-size=16g ...
   ```
2. **使用宿主机 IPC**：直接复用宿主机共享内存（不隔离，性能最好，但有安全风险）。
   ```bash
   docker run --ipc=host ...
   ```

## 3. 内存限制 (`--memory`)
防止某个实验代码写了死循环或加载了超大 CSV，导致宿主机内存耗尽，SSH 都连不上。

- `--memory=32g`：限制容器最大使用 32GB 内存。
- `--memory-swap=32g`：限制内存+Swap 总量。如果设为和 memory 一样，表示禁用 Swap（推荐，因为 Swap 会导致训练极慢）。

```bash
# 限制最大 32G 内存，禁止 Swap
docker run -d --memory=32g --memory-swap=32g my-training-job
```

## 4. CPU 限制 (`--cpus`)
防止数据预处理（如 OpenCV 增强）占满所有 CPU 核，导致其他人无法操作。

- `--cpus=8`：限制容器最多使用 8 个 CPU 核心的时间片（可以是 4 个核跑 200%，也可以是 8 个核跑 100%）。
- `--cpuset-cpus="0-7"`：绑定到物理核 0-7（性能更好，减少上下文切换）。

```bash
# 限制使用 8 个核
docker run -d --cpus=8 ...
```

## 5. 常见 OOM (Out Of Memory) 辨析

| 现象 | 报错信息 | 原因 | 归属 |
| :--- | :--- | :--- | :--- |
| **CUDA OOM** | `RuntimeError: CUDA out of memory` | 显存不足（Batch Size 太大）。 | **GPU 显存** |
| **System OOM** | 容器直接退出，Exit Code 137 | 内存不足（加载了太大的数据集到 RAM）。 | **系统内存** |
| **Bus Error** | `Bus error (core dumped)` | 共享内存不足（DataLoader worker 太多）。 | **Shared Memory** |

> [!TIP] 最佳实践配置
> ```bash
> docker run -d \
>   --gpus all \
>   --shm-size=16g \
>   --memory=64g \
>   --cpus=16 \
>   my-image
> ```

