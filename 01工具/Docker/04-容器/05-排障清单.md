# Docker 排障清单

## 适用场景
- 容器启动失败、服务连不上、训练中途崩溃等常见问题的快速自查手册。

## 1. 容器启动失败 (Status: Exited)
容器刚运行就退出，或者状态一直是 Restarting。

| 现象 | 可能原因 | 排查命令 |
| :--- | :--- | :--- |
| **Exit Code 127** | `command not found`。CMD 或 ENTRYPOINT 写错了，或者脚本里调用了未安装的命令。 | `docker logs <id>` |
| **Exit Code 126** | `Permission denied`。启动脚本没有执行权限 (`chmod +x`)。 | `docker logs <id>` |
| **exec format error** | 架构不匹配。在 x86 机器上跑了 ARM (M1 Mac) 的镜像。 | `docker inspect <image> \| grep Architecture` |
| **Python 报错** | 依赖缺失、代码 Bug。 | `docker logs <id>` |

## 2. 深度学习特定错误

### 2.1 找不到 GPU
- **报错**: `AssertionError: Torch not compiled with CUDA enabled` 或 `RuntimeError: Found no NVIDIA driver on your system`。
- **原因**: 启动时忘记加 `--gpus all`，或者宿主机 NVIDIA Toolkit 没装好。
- **检查**:
  ```bash
  # 验证容器内能否看到 GPU
  docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi
  ```

### 2.2 Bus Error (Core Dumped)
- **报错**: 训练跑一会就崩溃，报错 `Bus error`。
- **原因**: 共享内存 (`/dev/shm`) 不足。PyTorch DataLoader 默认使用共享内存。
- **解决**: 添加 `--shm-size=8g` 或 `--ipc=host`。

### 2.3 端口连不上 (TensorBoard/Jupyter)
- **现象**: 容器运行中，但浏览器访问 `localhost:6006` 失败。
- **原因 1**: 忘记 `-p` 端口映射。
- **原因 2**: 服务监听了 `127.0.0.1` (Localhost)，导致外部无法访问。**必须监听 `0.0.0.0`**。
  - *错误*: `tensorboard --logdir logs` (默认可能只听 localhost)
  - *正确*: `tensorboard --logdir logs --bind_all` 或 `--host 0.0.0.0`

## 3. 权限问题 (Permission Denied)
- **现象**: 容器内无法写入挂载的目录 (`-v /data:/data`)。
- **原因**: 宿主机目录属于 `root` 或其他用户，而容器内以非 root 用户 (`uid=1000`) 运行。
- **解决**:
  1. (粗暴) `chmod 777 /data` (宿主机)。
  2. (推荐) 启动时指定用户 ID：`docker run -u $(id -u):$(id -g) ...` (需镜像支持)。

## 4. 镜像拉取失败
- **Timeout / Connection Refused**: 国内网络问题。配置镜像加速器（如阿里云、清华源）。
- **manifest unknown**: 镜像标签（Tag）写错了，或者该镜像不支持当前架构（amd64/arm64）。

## 5. 常用排查命令速查
```bash
# 1. 看日志 (最重要)
docker logs --tail 50 <container_id>

# 2. 看容器详情 (挂载路径、环境变量、启动命令)
docker inspect <container_id>

# 3. 进容器现场查看
docker exec -it <container_id> bash

# 4. 看资源占用 (是否 CPU 跑满或死锁)
docker stats
```

