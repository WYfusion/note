# 镜像导入导出与迁移 (save/load vs export/import)

## 适用场景
- 服务器在内网，无法连接 Docker Hub，需要离线安装软件。
- 需要把本地构建的镜像复制到另一台机器。
- **深度学习场景**：模型镜像动辄 10GB+，需要高效迁移。

## 核心区别速查表
| 特性 | `docker save` / `load` | `docker export` / `import` |
| :--- | :--- | :--- |
| **操作对象** | **镜像 (Image)** | **容器 (Container)** |
| **层信息** | **保留**（所有历史层） | **丢失**（合并为一层） |
| **元数据** | **保留**（CMD, ENV, EXPOSE 等） | **丢失**（需 import 时重新指定） |
| **回滚能力** | 可以回滚到上一层 | 无法回滚 |
| **体积** | 较大（包含历史） | 较小（只有当前文件快照） |
| **主要用途** | **镜像迁移、离线分发** | **制作基础镜像、快照备份** |

---

## 1. 镜像迁移：`save` 与 `load` (推荐)
这是最常用的离线部署方式。

### 导出 (Save)
把一个或多个镜像打包成 tar 文件。
```bash
# 导出单个镜像 (注意：深度学习镜像很大，建议加 gzip 压缩)
docker save my-pytorch:v1 | gzip > my-pytorch-v1.tar.gz

# 导出多个镜像（推荐）
docker save -o images.tar nginx:latest redis:alpine
```

### 导入 (Load)
在另一台机器上加载。
```bash
# 加载 gzip 压缩包
docker load -i my-pytorch-v1.tar.gz
```
**注意**：加载后，镜像的 Tag 也会自动恢复。

---

## 2. 容器快照：`export` 与 `import`
这通常用于“把一个运行过的容器变成一个新的基础镜像”。

### 导出 (Export)
把容器的文件系统（当前状态）打包。
```bash
# 先启动一个容器
docker run -d --name my-lab pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime

# 导出容器的文件系统
docker export -o lab-fs.tar my-lab
```

### 导入 (Import)
把 tar 包变成一个新的镜像。
**注意**：因为元数据丢了，你可能需要手动指定 CMD。
```bash
# 语法：docker import [文件] [新镜像名]
docker import lab-fs.tar my-lab-base:v1

# 也可以在导入时指定 CMD
docker import --change 'CMD ["/bin/bash"]' lab-fs.tar my-lab-base:v1
```

## 常见问题
### Q: 为什么 `load` 进来的镜像没有 Tag，显示 `<none>`？
A: 通常是因为你 `save` 的时候用的是 Image ID 而不是 Image Name。
**错误示范**：`docker save -o img.tar a1b2c3d4`
**正确示范**：`docker save -o img.tar myapp:v1`

### Q: 深度学习镜像太大 (10GB+)，`save/load` 很慢怎么办？
A: 
1. **使用 gzip 压缩**：`docker save xxx | gzip > xxx.tar.gz`，通常能压到 50% 左右。
2. **搭建私有 Registry**：如果机器间网络互通，搭建一个 Harbor 或简单的 Registry，通过 `push/pull` 传输，Docker 会自动利用分层传输，只传变动的层（Layer），比全量拷贝 tar 包快得多。

