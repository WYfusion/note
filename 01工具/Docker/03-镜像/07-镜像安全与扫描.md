# 镜像安全与扫描

## 适用场景
- 公司要求过等保/安全合规。
- 担心引用的开源镜像（如 PyTorch 社区镜像）里有挖矿脚本或高危漏洞。
- 防止密钥（如 HuggingFace Token, WandB Key）泄露。

## 核心工具：Trivy (推荐)
Trivy 是目前最流行的开源容器安全扫描工具，安装简单，数据库更新快。

### 1. 安装 Trivy
```bash
# Ubuntu / Debian
sudo apt-get install wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy

# MacOS
brew install trivy
```

### 2. 扫描镜像
```bash
# 扫描本地镜像
trivy image pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime

# 扫描结果过滤（只看高危漏洞）
trivy image --severity HIGH,CRITICAL python:3.9-slim
```
**输出解读**：它会列出所有系统包（apt/apk）和应用包（pip/npm）的已知漏洞（CVE），并给出修复版本建议。
- **Python 包漏洞**：例如 `numpy` 旧版本可能有反序列化漏洞。
- **系统包漏洞**：例如 `openssl` 需要升级。

### 3. 扫描文件系统/代码
Trivy 也可以扫描当前目录下的 Dockerfile 配置问题或代码里的密钥。
```bash
trivy fs .
```

## 最佳实践清单

### 1. 最小权限原则 (Non-root)
默认情况下，容器内进程是 root。如果 Jupyter Notebook 被攻破，黑客可能获得宿主机 root 权限（如果挂载了敏感目录）。
**做法**：在 Dockerfile 里创建普通用户并切换。

```dockerfile
RUN useradd -m -u 1000 appuser
USER appuser
CMD ["jupyter", "notebook", "--ip=0.0.0.0"]
```

### 2. 基础镜像选择
- **首选**：官方镜像 (Official Image) 或 NVIDIA 官方镜像 (`nvcr.io/nvidia/cuda`)。
- **次选**：Verified Publisher。
- **避免**：随便搜出来的个人镜像（可能有后门）。
- **推荐**：使用 `slim` 版本，组件越少，漏洞越少。

### 3. 敏感信息不入镜像
- **严禁**：`COPY id_rsa .` 或 `ENV HF_TOKEN=xxx`。
- **正确**：
  - 运行时传入：`docker run -e HF_TOKEN=xxx ...`
  - 构建时挂载：使用 BuildKit 的 `--mount=type=secret`。

### 4. 定期更新与重建
漏洞是动态发现的。今天的安全镜像，明天可能就爆出 CVE。
**策略**：CI/CD 流水线里定期（如每周）触发构建，并运行 Trivy 扫描，如果有高危漏洞则阻断发布。

## 进阶概念
- **SBOM (Software Bill of Materials)**: 软件物料清单。就像食品配料表，列出镜像里所有软件包的版本。工具：`Syft`。
- **镜像签名 (Signing)**: 证明“这个镜像确实是我构建的，没被篡改过”。工具：`Cosign`。

