# 端口映射与连通性

## 适用场景
- 启动了 Jupyter/TensorBoard 但浏览器打不开。
- 需要同时跑多个实验，端口冲突了。
- 容器内代码想连接宿主机的 MySQL 或代理服务。

## 1. 端口映射 (`-p`)
容器内的端口默认是**封闭**的。必须通过 `-p` 参数“打洞”才能被外部访问。

### 语法详解
```bash
-p [宿主机IP]:[宿主机端口]:[容器端口]/[协议]
```

| 写法 | 含义 | 示例 |
| :--- | :--- | :--- |
| `-p 80:80` | 将宿主机所有网卡的 80 映射到容器 80。 | Web 服务标准用法。 |
| `-p 8080:80` | 将宿主机 8080 映射到容器 80。 | 宿主机 80 被占用了，换个口。 |
| `-p 127.0.0.1:80:80` | **仅允许宿主机本机访问**，局域网其他人连不上。 | **Jupyter/数据库等敏感服务推荐**。 |
| `-p 6006-6010:6006-6010` | 批量映射一段端口。 | 分布式训练多进程通信。 |

### 深度学习常用端口模板
```bash
docker run -d \
  -p 8888:8888 \  # JupyterLab
  -p 6006:6006 \  # TensorBoard
  -p 2222:22 \    # SSH (宿主机通常占用了 22，所以映射到 2222)
  my-dl-image
```

## 2. 连通性常见坑点

### 坑点 1：容器内服务监听了 `127.0.0.1`
**现象**：`-p 8080:8080` 映射了，容器也启动了，但宿主机 `curl localhost:8080` 报错 `Connection reset`。
**原因**：容器内的进程（如 Flask, TensorBoard）默认只监听了 `localhost` (127.0.0.1)。
- 在容器里，`localhost` 指的是容器自己。
- 外部请求进来时，看起来像是“外部 IP”，所以被拒绝了。
**解决**：**必须让服务监听 `0.0.0.0` (All Interfaces)**。
- TensorBoard: `--host 0.0.0.0`
- Flask/Django: `app.run(host='0.0.0.0')`
- Jupyter: `c.ServerApp.ip = '0.0.0.0'`

### 坑点 2：容器想访问宿主机服务
**场景**：容器里的代码想连宿主机的 MySQL，或者想走宿主机的代理 (10808)。
**错误做法**：在容器里填 `127.0.0.1`（这会连到容器自己）。
**正确做法**：
- **Windows/Mac**: 使用特殊域名 `host.docker.internal`。
  ```python
  # 连接宿主机数据库
  db = connect(host="host.docker.internal", port=3306)
  ```
- **Linux**: 默认不支持该域名。需在 `docker run` 时加 `--add-host host.docker.internal:host-gateway`。

## 3. 检查端口状态
如果映射了端口还是不通，按以下步骤排查：

1. **看 Docker 映射对不对**：
   ```bash
   docker ps
   # 0.0.0.0:8080->80/tcp  (正确：监听了所有网卡)
   # 127.0.0.1:8080->80/tcp (注意：只能本机连)
   ```

2. **看容器内服务活没活**：
   ```bash
   docker exec -it my-container netstat -tuln
   # 必须看到 Local Address 是 0.0.0.0:80 或 :::80
   ```

