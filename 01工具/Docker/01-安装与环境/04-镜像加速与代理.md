# 镜像加速与代理（Mirror / Proxy）

## 适用场景
- 拉取慢、公司代理、私有源、证书问题。

## 目录
- registry-mirror
- HTTP(S)_PROXY / NO_PROXY
- 公司内网自签证书与 CA
- Docker Desktop 与 WSL2 的代理差异

## 先搞清楚：你到底卡在哪一步
### 1) DNS / 连通性问题
表现：
- 任何站点都解析不了，或者一切连接都超时。

### 2) 被墙 / 网络慢（需要镜像源加速）
表现：
- `docker pull` 很慢，但并非直接失败。

### 3) 公司代理 / MITM 证书
表现：
- `proxyconnect tcp: ...`
- `x509: certificate signed by unknown authority`

> 经验：**国内“慢”优先用 mirror；公司内网“报错”优先看 proxy/证书。**

## 镜像加速（registry mirror）
### 它解决什么
- 主要解决：`docker pull` 慢。
- 不解决：公司代理认证、证书 MITM、私有仓库鉴权。

### 配置位置
#### Docker Desktop（Windows/Mac）
- 一般在 Docker Desktop 的设置中配置（不同版本 UI 文案略有差异）。

#### Linux Engine
在 `/etc/docker/daemon.json`：

```json
{
	"registry-mirrors": [
		"https://<你的镜像加速地址>"
	]
}
```

推荐设置为（包含国内常用源）：
```json
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://huecker.io",
    "https://docker.nju.edu.cn",
    "https://docker.mirrors.ustc.edu.cn",
    "http://hub-mirror.c.163.com"
  ]
}
```

> [!NOTE] 关于国内源的说明
> 1. **阿里源**：没有通用的公开地址。你需要登录 [阿里云容器镜像服务](https://cr.console.aliyun.com/) -> 镜像工具 -> 镜像加速器，获取你的**专属加速地址**（格式为 `https://<你的ID>.mirror.aliyuncs.com`），效果通常最好。
> 2. **清华源**：清华 TUNA 目前主要提供 pip/apt 软件源，Docker Hub 加速服务建议使用 **南京大学** 或 **中科大**。
> 3. **稳定性**：国内镜像源经常波动或失效，建议同时配置多个。如果都失效，请使用下文的“代理配置”。

保存后重启：

```bash
sudo systemctl restart docker
```

验证是否生效：
- `docker info` → `Registry Mirrors` 字段。

## 代理（HTTP(S)_PROXY / NO_PROXY）
### 代理应该配置在哪一层
你可能有三层：
1. **Docker daemon（dockerd）**：影响 `docker pull` 等由 daemon 发起的网络请求。
2. **构建过程（docker build / BuildKit）**：影响 `RUN apt-get ...`、`pip install ...` 等。
3. **容器运行时环境（docker run -e ...）**：影响容器内应用访问外网。

> 误区：只在 shell 里 `export HTTP_PROXY=...` 往往只影响你当前终端，不一定影响 dockerd。

### 常用环境变量
- `HTTP_PROXY`
- `HTTPS_PROXY`
- `NO_PROXY`

### 实战配置：宿主机代理 (端口 10808)

#### 1. Docker Desktop (Windows)
这是最推荐的方式，它会自动处理 Docker 守护进程（Pull 镜像）的代理。
1. 打开 Docker Desktop 设置 -> **Resources** -> **Proxies**。
2. 开启 **Manual proxy configuration**。
3. 填写配置：
   - **Web Server (HTTP)**: `http://127.0.0.1:10808`
   - **Secure Web Server (HTTPS)**: `http://127.0.0.1:10808`
   - **Bypass proxy settings**: `localhost,127.0.0.1,*.docker.internal`
4. 点击 **Apply & restart**。

#### 2. 容器运行时 (临时使用)
如果你只想让某个容器走代理（例如在容器里 `pip install`）：
```bash
# 注意：在 Windows Docker 容器内访问宿主机端口，需使用 host.docker.internal
docker run --rm \
    -e HTTP_PROXY=http://host.docker.internal:10808 \
    -e HTTPS_PROXY=http://host.docker.internal:10808 \
    ubuntu curl -I https://www.google.com
```

#### 3. Linux (Systemd)
如果是在 Linux 服务器上：
创建 `/etc/systemd/system/docker.service.d/http-proxy.conf`：
```ini
[Service]
Environment="HTTP_PROXY=http://127.0.0.1:10808"
Environment="HTTPS_PROXY=http://127.0.0.1:10808"
Environment="NO_PROXY=localhost,127.0.0.1"
```
然后执行：
```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 示例（通用参考）
```bash
docker run --rm \
	-e HTTP_PROXY=http://proxy.example.com:8080 \
	-e HTTPS_PROXY=http://proxy.example.com:8080 \
	-e NO_PROXY=localhost,127.0.0.1,.example.com \
	ubuntu env
```

#### NO_PROXY 写法注意
- `localhost,127.0.0.1`：本机与回环
- `.example.com`：匹配子域（如 a.example.com）
- 常见还需要加：公司内网域名、私有 Registry 域名、K8s 集群域名等。

### Docker Desktop + WSL2 的差异（重点）
你可能会遇到：
- Desktop 里 pull 能用，但在 WSL2 里某些网络请求不通
- 或者相反：WSL2 里 curl 能通，但 docker pull 不通

建议排障顺序：
1. 用 `docker info` 看是否已经识别到 proxy 字段
2. 用 `docker pull hello-world` 验证 daemon 侧网络
3. 如果是 build 里 `apt/pip` 失败，再考虑 build 阶段代理（ARG/ENV/BuildKit）

## 证书与自签 CA（x509 报错的根因）
### 常见错误
`x509: certificate signed by unknown authority`

典型原因：
- 公司网络做了 HTTPS 中间人（MITM），签了自己的证书
- 内网私有仓库是自签证书

处理思路：
- **把公司 CA 或私有仓库 CA 安装到 Docker 信任链**。
- 不建议一上来就用 `insecure-registries`（除非你完全理解其风险）。

### “不安全仓库”选项（谨慎）
Linux daemon.json 可配置：

```json
{
	"insecure-registries": ["registry.example.com:5000"]
}
```

风险：
- 跳过 TLS 校验或使用不安全传输会降低安全性。

## 关键例子：判断是 mirror、proxy 还是证书问题
### 例 1：超时（timeout）
更可能是：网络/防火墙/代理未配置。

### 例 2：`proxyconnect tcp: ...`
更可能是：代理地址/认证/端口不对，或 dockerd 没拿到代理配置。

### 例 3：`x509 ... unknown authority`
更可能是：TLS 证书链不受信任（需要 CA）。

## 推荐的“最小可用配置清单”（从易到难）
1. 能跑 `docker run --rm hello-world`
2. 配一个镜像源（解决慢）
3. 公司网络需要时再配置 dockerd 代理
4. 遇到 x509 再处理 CA

## 常见报错速查
- `net/http: request canceled while waiting for connection (Client.Timeout exceeded...)`
	- 方向：网络/代理/镜像源
- `proxyconnect tcp: dial tcp ...: connectex: No connection could be made`
	- 方向：代理地址不对/被防火墙阻断
- `x509: certificate signed by unknown authority`
	- 方向：CA/证书链

## 针对“下载卡住/EOF”的专项排障
**现象**：
- 下载大镜像（如 PyTorch 基础层 3GB+）时，进度条卡在某个百分比不动。
- 报错 `rpc error: code = Unavailable desc = error reading from server: EOF`。
- 报错 `failed to fetch ... connection reset by peer`。

**解决方案（按顺序尝试）**：

### 1. 手动 Pull 基础镜像（最推荐）
`docker build` 的下载重试机制较弱。建议先手动拉取 Dockerfile 中的 `FROM` 镜像：
```bash
# 先单独拉取基础镜像
docker pull pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime

# 拉取成功后，再执行 build，Docker 会直接使用本地缓存
docker build -t my-pytorch:v2 .
```

### 2. 限制并发下载数
默认 Docker 会同时下载 3 层，带宽不足或代理不稳定时容易导致 TCP 连接超时。
在 Docker Engine 配置中（`daemon.json`）添加：
```json
{
  "max-concurrent-downloads": 1
}
```
*改为串行下载，虽然理论速度慢了，但对于大文件更稳定。*

### 3. 检查代理稳定性
如果你配置了 `10808` 代理：
- 确保你的代理软件开启了 **"Allow LAN" (允许局域网连接)**，否则 Docker 容器/虚拟机可能连不上宿主机 IP。
- 尝试切换代理节点的地区（部分节点对 Docker Hub 限速）。


