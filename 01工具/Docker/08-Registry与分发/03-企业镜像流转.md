# 企业镜像流转 (Dev -> Prod)

## 适用场景
- 离线环境交付（客户现场没有网）。
- 规范化发布流程（开发 -> 测试 -> 生产）。

## 1. 离线流转：Save 与 Load
适用于完全物理隔离的环境。

### 导出 (Save)
将镜像保存为 `.tar` 文件。
```bash
# 导出单个镜像
docker save -o my-app-v1.tar my-app:v1

# 导出多个镜像 (推荐)
docker save -o project-images.tar my-app:v1 redis:alpine postgres:15
```
*技巧：对于大镜像，可以配合 gzip 压缩：*
```bash
docker save my-app:v1 | gzip > my-app-v1.tar.gz
```

### 导入 (Load)
在目标机器上加载。
```bash
docker load -i my-app-v1.tar
```

> [!NOTE] Save vs Export
> - `docker save`: 保存**镜像**的所有层和元数据（可回滚）。**推荐**。
> - `docker export`: 保存**容器**的文件系统快照（丢失层历史，无法回滚）。**不推荐**。

## 2. 在线流转：Tag 晋级策略
在有 Registry 的环境中，通过 Tag 来标记生命周期。

### 阶段 1: 开发 (Dev)
开发人员提交代码，CI 构建镜像，打上 Commit ID。
- Tag: `myapp:dev-a1b2c3d`
- 部署到开发环境测试。

### 阶段 2: 测试 (QA)
测试通过后，给同一个镜像 ID 打上 RC (Release Candidate) 标签。
- Tag: `myapp:v1.0.0-rc1`
- **注意**：不要重新构建！要保证测试的二进制文件和生产的一模一样。
  ```bash
  docker pull myapp:dev-a1b2c3d
  docker tag myapp:dev-a1b2c3d myapp:v1.0.0-rc1
  docker push myapp:v1.0.0-rc1
  ```

### 阶段 3: 生产 (Prod)
上线前，打上正式版本号。
- Tag: `myapp:v1.0.0`
- 同时更新 `latest` (可选)。

## 3. 镜像清理策略
私有仓库运行久了会占用巨大磁盘。
- **保留策略**: 保留最近 5 个版本 + 所有 SemVer 正式版 (v1.0, v1.1)。
- **清理**: 删除旧的 `dev-*` 标签，并运行 Registry 的垃圾回收 (Garbage Collection)。


## TODO
- [ ] 给出一个“最小可落地流程”清单
