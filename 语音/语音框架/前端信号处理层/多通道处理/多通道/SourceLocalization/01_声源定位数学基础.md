# 声源定位数学基础

## 1. 概述

声源定位的核心是通过麦克风阵列测量的信号，反推声源的空间位置。本文介绍定位问题的数学基础，包括TDOA、DOA和几何关系。

---

## 2. 时间差 (TDOA)

### 2.1 基本定义

**时间差 (Time Difference of Arrival, TDOA)** 是声波到达不同麦克风的时间差。

对于麦克风 $i$ 和 $j$：

$$\tau_{ij} = t_i - t_j = \frac{d_i - d_j}{c}$$

其中：
- $t_i, t_j$：声波到达时间
- $d_i, d_j$：声源到麦克风的距离
- $c$：声速（约343 m/s，20°C）

### 2.2 几何关系

**2D情况**：

设声源位置 $\mathbf{r}_s = (x_s, y_s)$，麦克风位置 $\mathbf{r}_i = (x_i, y_i)$：

$$d_i = \|\mathbf{r}_s - \mathbf{r}_i\| = \sqrt{(x_s - x_i)^2 + (y_s - y_i)^2}$$

因此：

$$\tau_{ij} = \frac{1}{c}\left(\sqrt{(x_s - x_i)^2 + (y_s - y_i)^2} - \sqrt{(x_s - x_j)^2 + (y_s - y_j)^2}\right)$$

**3D情况**：

$$d_i = \sqrt{(x_s - x_i)^2 + (y_s - y_i)^2 + (z_s - z_i)^2}$$

### 2.3 双曲线定位

固定TDOA $\tau_{ij}$ 定义了一条**双曲线**（2D）或**双曲面**（3D）：

$$d_i - d_j = c\tau_{ij} = \text{常数}$$

**双曲线方程**（2D，以麦克风连线为x轴）：

$$\frac{x^2}{a^2} - \frac{y^2}{b^2} = 1$$

其中：
- $a = \frac{c\tau_{ij}}{2}$
- $b = \sqrt{(\frac{d_{ij}}{2})^2 - a^2}$
- $d_{ij} = \|\mathbf{r}_i - \mathbf{r}_j\|$

**定位原理**：
- 2个麦克风 → 1条双曲线（1D约束）
- 3个麦克风 → 2条双曲线 → 交点（2D定位）
- 4个麦克风 → 3条双曲线 → 交点（3D定位）

### 2.4 TDOA估计

**互相关法**：

$$\hat{\tau}_{ij} = \arg\max_{\tau} R_{ij}(\tau)$$

其中互相关函数：

$$R_{ij}(\tau) = \int_{-\infty}^{\infty} x_i(t) x_j(t - \tau) dt$$

**频域实现**：

$$R_{ij}(\tau) = \text{IFFT}\{X_i(f) X_j^*(f)\}$$

---

## 3. 方向角 (DOA)

### 3.1 基本定义

**方向角 (Direction of Arrival, DOA)** 描述声源相对于阵列的方向。

**2D情况**（平面）：
- 方位角 $\theta \in [0, 2\pi)$

**3D情况**（空间）：
- 方位角 $\theta \in [0, 2\pi)$（水平面）
- 俯仰角 $\phi \in [-\pi/2, \pi/2]$（垂直面）

### 3.2 球坐标系

声源位置的球坐标表示：

$$\begin{cases}
x = r\sin\phi\cos\theta \\
y = r\sin\phi\sin\theta \\
z = r\cos\phi
\end{cases}$$

或者（另一种定义）：

$$\begin{cases}
x = r\cos\phi\cos\theta \\
y = r\cos\phi\sin\theta \\
z = r\sin\phi
\end{cases}$$

**方向单位矢量**：

$$\mathbf{u}(\theta, \phi) = \begin{bmatrix}
\cos\phi\cos\theta \\
\cos\phi\sin\theta \\
\sin\phi
\end{bmatrix}$$

### 3.3 DOA与TDOA的关系

**远场假设**下（$r \gg D$，$D$为阵列孔径）：

$$\tau_{ij} \approx \frac{\mathbf{u}^T(\mathbf{r}_i - \mathbf{r}_j)}{c} = \frac{\mathbf{u}^T\mathbf{d}_{ij}}{c}$$

其中 $\mathbf{d}_{ij} = \mathbf{r}_i - \mathbf{r}_j$ 是麦克风间的位置差。

**线性阵列**（沿x轴，间距$d$）：

$$\tau_{ij} = \frac{(i-j)d\cos\theta}{c}$$

**推导**：
- 麦克风位置：$\mathbf{r}_i = [id, 0, 0]^T$
- 方向矢量：$\mathbf{u} = [\cos\theta, \sin\theta, 0]^T$
- $\mathbf{d}_{ij} = [(i-j)d, 0, 0]^T$
- $\tau_{ij} = \frac{1}{c}\mathbf{u}^T\mathbf{d}_{ij} = \frac{(i-j)d\cos\theta}{c}$

---

## 4. 相位差 (PDOA)

### 4.1 基本定义

**相位差 (Phase Difference of Arrival, PDOA)** 是频域中的时延表示：

$$\Delta\phi_{ij}(f) = 2\pi f \tau_{ij}$$

### 4.2 相位模糊性

当 $|\Delta\phi_{ij}| > \pi$ 时，存在**相位缠绕 (phase wrapping)**：

$$\Delta\phi_{ij}^{\text{wrapped}} = \text{angle}(e^{j\Delta\phi_{ij}}) \in (-\pi, \pi]$$

**最大无模糊距离**：

$$d_{\max} = \frac{c}{2f}$$

**示例**：
- $f = 1$ kHz：$d_{\max} = 17.15$ cm
- $f = 4$ kHz：$d_{\max} = 4.29$ cm

**解决方法**：
1. 限制麦克风间距：$d_{ij} < d_{\max}$
2. 多频率联合估计
3. 相位解缠绕算法

### 4.3 宽带信号的相位

对于宽带信号，不同频率有不同的相位差：

$$\Delta\phi_{ij}(f) = 2\pi f \tau_{ij}$$

**线性相位**：理想情况下，$\Delta\phi$ 与 $f$ 成正比，斜率为 $2\pi\tau_{ij}$。

**相位谱估计TDOA**：

$$\hat{\tau}_{ij} = \frac{1}{2\pi} \frac{d\Delta\phi_{ij}(f)}{df}$$

---

## 5. 远场与近场

### 5.1 远场条件

**远场 (Far-field)** 假设声源距离远大于阵列孔径：

$$r > \frac{2D^2}{\lambda}$$

其中：
- $r$：声源距离
- $D$：阵列最大孔径
- $\lambda = c/f$：波长

**示例**：
- $D = 0.2$ m，$f = 1$ kHz，$\lambda = 0.343$ m
- $r > \frac{2 \times 0.2^2}{0.343} \approx 0.23$ m

**远场特性**：
- 声波可近似为**平面波**
- 到达角相同，只有时延差
- TDOA与距离无关，只与方向有关

### 5.2 近场模型

**近场 (Near-field)** 需要考虑**球面波**：

$$\tau_{ij} = \frac{\|\mathbf{r}_s - \mathbf{r}_i\| - \|\mathbf{r}_s - \mathbf{r}_j\|}{c}$$

**特点**：
- TDOA依赖于声源位置 $(x, y, z)$
- 可以估计距离
- 计算更复杂

**泰勒展开近似**：

对于小孔径阵列，可以展开：

$$d_i \approx r - \mathbf{u}^T\mathbf{r}_i - \frac{1}{2r}(\mathbf{r}_i - (\mathbf{u}^T\mathbf{r}_i)\mathbf{u})^T(\mathbf{r}_i - (\mathbf{u}^T\mathbf{r}_i)\mathbf{u})$$

第一项：距离
第二项：远场项（方向）
第三项：近场修正（曲率）

---

## 6. 定位几何

### 6.1 三角定位（2D）

**已知**：3个麦克风位置和2个TDOA

**方程组**：

$$\begin{cases}
d_1 - d_2 = c\tau_{12} \\
d_1 - d_3 = c\tau_{13}
\end{cases}$$

其中：

$$d_i = \sqrt{(x - x_i)^2 + (y - y_i)^2}$$

**求解方法**：
1. 非线性最小二乘
2. 闭式解（特殊几何）
3. 迭代优化

### 6.2 多边定位（3D）

**已知**：4个麦克风位置和3个TDOA

**方程组**：

$$\begin{cases}
d_1 - d_2 = c\tau_{12} \\
d_1 - d_3 = c\tau_{13} \\
d_1 - d_4 = c\tau_{14}
\end{cases}$$

**Chan算法**（闭式解）：

将非线性方程转化为线性方程组，两步求解。

**步骤1**：引入辅助变量 $r_1 = d_1$

$$d_i^2 = (x - x_i)^2 + (y - y_i)^2 + (z - z_i)^2$$

$$d_i^2 - d_1^2 = -2(x_i - x_1)x - 2(y_i - y_1)y - 2(z_i - z_1)z + K_i$$

其中 $K_i = x_i^2 + y_i^2 + z_i^2 - x_1^2 - y_1^2 - z_1^2$

利用 $d_i = d_1 + c\tau_{1i}$：

$$d_i^2 = d_1^2 + 2d_1 c\tau_{1i} + c^2\tau_{1i}^2$$

代入得到关于 $(x, y, z, d_1)$ 的线性方程。

### 6.3 最小二乘估计

**目标函数**：

$$\hat{\mathbf{r}}_s = \arg\min_{\mathbf{r}_s} \sum_{i,j} \left(\tau_{ij}^{\text{meas}} - \tau_{ij}(\mathbf{r}_s)\right)^2$$

其中：

$$\tau_{ij}(\mathbf{r}_s) = \frac{\|\mathbf{r}_s - \mathbf{r}_i\| - \|\mathbf{r}_s - \mathbf{r}_j\|}{c}$$

**优化方法**：
- Gauss-Newton
- Levenberg-Marquardt
- 梯度下降

---

## 7. 性能界限

### 7.1 Cramér-Rao下界 (CRLB)

定位估计的理论下界：

$$\text{Var}(\hat{\theta}) \geq \text{CRLB}(\theta) = \mathcal{I}^{-1}(\theta)$$

其中 $\mathcal{I}(\theta)$ 是Fisher信息矩阵。

**TDOA估计的CRLB**：

$$\text{CRLB}(\tau_{ij}) = \frac{1}{8\pi^2\beta^2\text{SNR}}$$

其中：
- $\beta = \int f^2 |S(f)|^2 df / \int |S(f)|^2 df$：有效带宽
- SNR：信噪比

**DOA估计的CRLB**（远场）：

$$\text{CRLB}(\theta) = \frac{6c^2}{(2\pi f)^2 d^2 P(P^2-1)\text{SNR}}$$

其中 $P$ 是麦克风数量。

### 7.2 分辨率

**Rayleigh准则**：

两个声源可分辨的最小角度间隔：

$$\Delta\theta_{\min} \approx \frac{\lambda}{D} = \frac{c}{fD}$$

**示例**：
- $f = 1$ kHz，$D = 0.2$ m
- $\Delta\theta_{\min} \approx \frac{343}{1000 \times 0.2} = 1.715$ rad $\approx 98°$

**提高分辨率**：
1. 增大阵列孔径 $D$
2. 提高频率 $f$
3. 使用子空间方法（MUSIC）

---

## 8. 坐标系变换

### 8.1 笛卡尔坐标 ↔ 球坐标

**笛卡尔 → 球坐标**：

$$\begin{cases}
r = \sqrt{x^2 + y^2 + z^2} \\
\theta = \arctan2(y, x) \\
\phi = \arcsin(z/r)
\end{cases}$$

**球坐标 → 笛卡尔**：

$$\begin{cases}
x = r\cos\phi\cos\theta \\
y = r\cos\phi\sin\theta \\
z = r\sin\phi
\end{cases}$$

### 8.2 阵列坐标系 ↔ 全局坐标系

**旋转矩阵**：

$$\mathbf{r}_{\text{global}} = \mathbf{R}\mathbf{r}_{\text{array}} + \mathbf{t}$$

其中：
- $\mathbf{R}$：旋转矩阵
- $\mathbf{t}$：平移向量

**欧拉角旋转**（ZYX顺序）：

$$\mathbf{R} = \mathbf{R}_z(\psi)\mathbf{R}_y(\theta)\mathbf{R}_x(\phi)$$

---

## 9. 数值示例

### 9.1 双麦克风TDOA定位

**配置**：
- 麦克风1：$(0, 0)$
- 麦克风2：$(0.1, 0)$ m
- 声源：$(1, 1)$ m
- 声速：$c = 343$ m/s

**计算**：

$$d_1 = \sqrt{1^2 + 1^2} = 1.414 \text{ m}$$
$$d_2 = \sqrt{1^2 + 1^2} = 1.414 \text{ m}$$
$$\tau_{12} = \frac{1.414 - 1.414}{343} = 0 \text{ ms}$$

声源在两麦克风的中垂线上，TDOA为0。

**改变声源位置**：$(1, 0)$ m

$$d_1 = 1 \text{ m}$$
$$d_2 = \sqrt{0.9^2 + 0^2} = 0.9 \text{ m}$$
$$\tau_{12} = \frac{1 - 0.9}{343} = 0.292 \text{ ms}$$

### 9.2 线性阵列DOA估计

**配置**：
- 4元线性阵列，间距 $d = 0.05$ m
- 频率：$f = 2$ kHz
- 声源方向：$\theta = 30°$

**相位差**：

$$\Delta\phi_{12} = 2\pi f \frac{d\cos\theta}{c} = 2\pi \times 2000 \times \frac{0.05 \times \cos(30°)}{343} \approx 1.59 \text{ rad}$$

**检查模糊性**：

$$d_{\max} = \frac{c}{2f} = \frac{343}{4000} = 0.086 \text{ m}$$

由于 $d = 0.05 < d_{\max}$，无相位模糊。

---

## 10. Python实现

```python
import numpy as np

class SourceLocalization:
    def __init__(self, mic_positions, c=343):
        """
        参数:
            mic_positions: [P, 3] - 麦克风位置
            c: 声速 (m/s)
        """
        self.mic_pos = np.array(mic_positions)
        self.c = c
        self.P = len(mic_positions)
    
    def compute_tdoa(self, source_pos):
        """计算理论TDOA"""
        distances = np.linalg.norm(
            self.mic_pos - source_pos, axis=1
        )
        # 相对于第一个麦克风
        tdoa = (distances - distances[0]) / self.c
        return tdoa
    
    def tdoa_to_position_2d(self, tdoa, method='least_squares'):
        """从TDOA估计2D位置"""
        if method == 'least_squares':
            from scipy.optimize import least_squares
            
            def residual(pos):
                pred_tdoa = self.compute_tdoa(
                    np.append(pos, 0)  # z=0
                )
                return pred_tdoa[1:] - tdoa[1:]
            
            # 初始猜测
            x0 = np.mean(self.mic_pos[:, :2], axis=0)
            result = least_squares(residual, x0)
            return result.x
    
    def doa_to_direction(self, theta, phi=0):
        """DOA角度转方向矢量"""
        return np.array([
            np.cos(phi) * np.cos(theta),
            np.cos(phi) * np.sin(theta),
            np.sin(phi)
        ])
    
    def direction_to_doa(self, direction):
        """方向矢量转DOA角度"""
        direction = direction / np.linalg.norm(direction)
        theta = np.arctan2(direction[1], direction[0])
        phi = np.arcsin(direction[2])
        return theta, phi

# 使用示例
mic_pos = np.array([
    [0, 0, 0],
    [0.1, 0, 0],
    [0.05, 0.087, 0]
])

loc = SourceLocalization(mic_pos)

# 计算TDOA
source = np.array([1, 1, 0])
tdoa = loc.compute_tdoa(source)
print(f"TDOA: {tdoa * 1000} ms")

# 从TDOA恢复位置
estimated_pos = loc.tdoa_to_position_2d(tdoa)
print(f"估计位置: {estimated_pos}")
print(f"真实位置: {source[:2]}")
```

---

## 11. 总结

声源定位的数学基础包括：

1. **TDOA**：时间差测量，定义双曲线/双曲面
2. **DOA**：方向角，远场假设下简化计算
3. **PDOA**：相位差，需注意模糊性
4. **几何关系**：三角/多边定位
5. **性能界限**：CRLB给出理论下界

**关键要点**：
- 远场 vs 近场：决定模型复杂度
- 相位模糊：限制麦克风间距
- 分辨率：受阵列孔径和频率限制
- 非线性优化：实际定位需要迭代求解
