# 超指向性波束形成 (Superdirective Beamforming)

## 1. 概述

**超指向性波束形成 (Superdirective Beamforming)** 是一种通过优化权重向量来最大化指向性因子的方法，可以在阵列孔径较小时获得比延迟求和更窄的主瓣和更高的指向性。

### 1.1 动机

延迟求和的指向性因子：
$$DF_{\text{DS}} \approx \frac{2D}{\lambda}$$

当 $D \ll \lambda$（低频或小阵列）时，$DF_{\text{DS}}$ 很小，指向性差。

**超指向性目标**：在小阵列上实现高指向性。

### 1.2 代价

- 白噪声增益降低
- 对阵列误差敏感
- 可能放大传感器噪声

---

## 2. 数学推导

### 2.1 优化问题

**目标**：最大化指向性因子

$$\max_{\mathbf{w}} DF = \frac{|\mathbf{w}^H\mathbf{d}(\theta_0)|^2}{\frac{1}{2\pi}\int_{-\pi}^{\pi} |\mathbf{w}^H\mathbf{d}(\theta)|^2 d\theta}$$

**分母**：全空间平均功率

对于扩散噪声场，协方差矩阵为：
$$[\mathbf{\Gamma}]_{ij} = \text{sinc}(kd_{ij})$$

其中 $d_{ij} = \|\mathbf{r}_i - \mathbf{r}_j\|$ 是麦克风 $i,j$ 间距。

因此：
$$\int_{-\pi}^{\pi} |\mathbf{w}^H\mathbf{d}(\theta)|^2 d\theta = 2\pi \mathbf{w}^H\mathbf{\Gamma}\mathbf{w}$$

**优化问题重写**：

$$\max_{\mathbf{w}} \frac{|\mathbf{w}^H\mathbf{d}(\theta_0)|^2}{\mathbf{w}^H\mathbf{\Gamma}\mathbf{w}}$$

### 2.2 拉格朗日乘数法

添加归一化约束 $\mathbf{w}^H\mathbf{d}(\theta_0) = 1$：

$$\min_{\mathbf{w}} \mathbf{w}^H\mathbf{\Gamma}\mathbf{w} \quad \text{s.t.} \quad \mathbf{w}^H\mathbf{d}(\theta_0) = 1$$

拉格朗日函数：
$$\mathcal{L}(\mathbf{w}, \lambda) = \mathbf{w}^H\mathbf{\Gamma}\mathbf{w} + \lambda(\mathbf{w}^H\mathbf{d} - 1) + \lambda^*(\mathbf{d}^H\mathbf{w} - 1)$$

对 $\mathbf{w}^*$ 求导：
$$\frac{\partial \mathcal{L}}{\partial \mathbf{w}^*} = \mathbf{\Gamma}\mathbf{w} + \lambda\mathbf{d} = 0$$

$$\mathbf{w} = -\lambda\mathbf{\Gamma}^{-1}\mathbf{d}$$

代入约束：
$$\lambda = -\frac{1}{\mathbf{d}^H\mathbf{\Gamma}^{-1}\mathbf{d}}$$

### 2.3 超指向性解

$$\mathbf{w}_{\text{SD}} = \frac{\mathbf{\Gamma}^{-1}\mathbf{d}(\theta_0)}{\mathbf{d}^H(\theta_0)\mathbf{\Gamma}^{-1}\mathbf{d}(\theta_0)}$$

**最大指向性因子**：
$$DF_{\max} = \mathbf{d}^H(\theta_0)\mathbf{\Gamma}^{-1}\mathbf{d}(\theta_0)$$

---

## 3. 扩散噪声场协方差矩阵

### 3.1 sinc函数

对于各向同性扩散噪声场：

$$[\mathbf{\Gamma}]_{ij} = \text{sinc}(kd_{ij}) = \frac{\sin(kd_{ij})}{kd_{ij}}$$

其中 $k = 2\pi f / c$ 是波数。

**物理意义**：
- 对角元素：$\Gamma_{ii} = 1$
- 非对角元素：随距离振荡衰减
- 低频时：$\Gamma_{ij} \approx 1$（高度相关）
- 高频时：$\Gamma_{ij} \approx 0$（低相关）

### 3.2 线性阵列的 $\mathbf{\Gamma}$

对于间距为 $d$ 的均匀线性阵列：

$$\Gamma_{ij} = \text{sinc}(k|i-j|d)$$

**示例**（4元阵列）：

$$\mathbf{\Gamma} = \begin{bmatrix}
1 & \text{sinc}(kd) & \text{sinc}(2kd) & \text{sinc}(3kd) \\
\text{sinc}(kd) & 1 & \text{sinc}(kd) & \text{sinc}(2kd) \\
\text{sinc}(2kd) & \text{sinc}(kd) & 1 & \text{sinc}(kd) \\
\text{sinc}(3kd) & \text{sinc}(2kd) & \text{sinc}(kd) & 1
\end{bmatrix}$$

### 3.3 条件数

$\mathbf{\Gamma}$ 的条件数：
$$\kappa(\mathbf{\Gamma}) = \frac{\lambda_{\max}}{\lambda_{\min}}$$

**低频时**：
- $\mathbf{\Gamma} \approx \mathbf{1}\mathbf{1}^T$（秩1矩阵）
- 条件数极大，接近奇异
- $\mathbf{\Gamma}^{-1}$ 数值不稳定

**高频时**：
- $\mathbf{\Gamma} \approx \mathbf{I}$
- 条件数接近1
- 数值稳定

---

## 4. 白噪声增益分析

### 4.1 WNG计算

$$WNG = \frac{|\mathbf{w}^H\mathbf{d}(\theta_0)|^2}{\mathbf{w}^H\mathbf{w}}$$

对于超指向性：
$$\mathbf{w}_{\text{SD}} = \frac{\mathbf{\Gamma}^{-1}\mathbf{d}}{\mathbf{d}^H\mathbf{\Gamma}^{-1}\mathbf{d}}$$

$$WNG = \frac{1}{\mathbf{d}^H\mathbf{\Gamma}^{-1}\mathbf{d} \cdot \mathbf{d}^H(\mathbf{\Gamma}^{-1})^H\mathbf{\Gamma}^{-1}\mathbf{d}}$$

由于 $\mathbf{\Gamma}$ 是实对称矩阵：
$$WNG = \frac{1}{\mathbf{d}^H\mathbf{\Gamma}^{-2}\mathbf{d}}$$

### 4.2 WNG与DF的权衡

**低频时**：
- $DF$ 可以很大（超指向性）
- 但 $WNG$ 很小（甚至负dB）
- 会放大传感器噪声

**高频时**：
- $\mathbf{\Gamma} \approx \mathbf{I}$
- 超指向性退化为延迟求和
- $WNG \approx P$

### 4.3 数值示例

**2元阵列**，$d = 0.05$ m：

| 频率 | $kd$ | $DF$ (dB) | $WNG$ (dB) |
|------|------|-----------|------------|
| 500 Hz | 0.46 | 6.0 | -3.0 |
| 1000 Hz | 0.92 | 4.8 | 0.8 |
| 2000 Hz | 1.83 | 3.5 | 2.5 |
| 4000 Hz | 3.66 | 3.1 | 2.9 |

**观察**：
- 低频时DF高但WNG低
- 高频时趋向延迟求和

---

## 5. 鲁棒超指向性

### 5.1 对角加载

为提高鲁棒性和WNG，添加对角加载：

$$\mathbf{w}_{\text{robust}} = \frac{(\mathbf{\Gamma} + \mu\mathbf{I})^{-1}\mathbf{d}}{\mathbf{d}^H(\mathbf{\Gamma} + \mu\mathbf{I})^{-1}\mathbf{d}}$$

其中 $\mu > 0$ 是加载因子。

**效果**：
- 增加WNG
- 降低DF
- 提高鲁棒性

### 5.2 约束WNG

在WNG约束下最大化DF：

$$\max_{\mathbf{w}} \frac{|\mathbf{w}^H\mathbf{d}|^2}{\mathbf{w}^H\mathbf{\Gamma}\mathbf{w}} \quad \text{s.t.} \quad \frac{|\mathbf{w}^H\mathbf{d}|^2}{\mathbf{w}^H\mathbf{w}} \geq \text{WNG}_{\min}$$

**解**：

$$\mathbf{w} = \frac{(\mathbf{\Gamma} + \mu\mathbf{I})^{-1}\mathbf{d}}{\mathbf{d}^H(\mathbf{\Gamma} + \mu\mathbf{I})^{-1}\mathbf{d}}$$

其中 $\mu$ 通过二分搜索确定，使得：
$$WNG(\mathbf{w}) = \text{WNG}_{\min}$$

### 5.3 最优权衡

**Pareto前沿**：

在DF-WNG平面上，通过调整 $\mu$ 可以得到一条权衡曲线。

```
DF (dB)
  ↑
  |     超指向性
  |    /
  |   /
  |  /  ← Pareto前沿
  | /
  |/___________→ WNG (dB)
     延迟求和
```

---

## 6. 差分麦克风阵列

### 6.1 一阶差分

**2麦克风**，间距 $d$：

$$y(t) = x_1(t) - x_2(t)$$

**频域**：
$$Y(f) = X_1(f) - X_2(f) = [1, -1]\mathbf{X}(f)$$

**波束图**：
$$B(\theta) = 1 - e^{-jkd\sin\theta} = 2je^{-jkd\sin\theta/2}\sin(kd\sin\theta/2)$$

$$|B(\theta)| = 2|\sin(kd\sin\theta/2)|$$

**指向性**：
- 8字形波束图
- 前后对称
- 零点在 $\theta = 0$（侧向）

### 6.2 心形指向性

**权重**：
$$\mathbf{w} = [0.5, -0.5]^T$$

加上全向分量：
$$y(t) = 0.5[x_1(t) + x_2(t)] + 0.5[x_1(t) - x_2(t)] = x_1(t)$$

实际实现：
$$y(t) = \alpha x_1(t) + (1-\alpha)[x_1(t) - x_2(t)]$$

**波束图**：
$$|B(\theta)| = |\alpha + (1-\alpha)(1 - e^{-jkd\sin\theta})|$$

选择 $\alpha = 0.5$：
$$|B(\theta)| = |1 + \cos(kd\sin\theta)|$$

这是心形指向性。

### 6.3 二阶差分

**3麦克风**：

$$y(t) = x_1(t) - 2x_2(t) + x_3(t)$$

**波束图**：
$$|B(\theta)| \propto |\sin^2(kd\sin\theta/2)|$$

**特点**：
- 更窄的主瓣
- 更高的指向性
- 更低的WNG

---

## 7. 实现与应用

### 7.1 Python实现

```python
import numpy as np

def superdirective_weights(mic_pos, theta0, f, c=343, mu=0):
    """
    计算超指向性权重
    
    参数:
        mic_pos: [P, 3] - 麦克风位置
        theta0: 目标方向（弧度）
        f: 频率
        c: 声速
        mu: 对角加载因子
    """
    P = len(mic_pos)
    k = 2 * np.pi * f / c
    
    # 计算扩散噪声场协方差矩阵
    Gamma = np.zeros((P, P))
    for i in range(P):
        for j in range(P):
            d_ij = np.linalg.norm(mic_pos[i] - mic_pos[j])
            if d_ij == 0:
                Gamma[i, j] = 1
            else:
                Gamma[i, j] = np.sinc(k * d_ij / np.pi)
    
    # 对角加载
    Gamma_reg = Gamma + mu * np.eye(P)
    
    # 计算导向矢量
    ref_pos = mic_pos[0]
    u = np.array([np.sin(theta0), np.cos(theta0), 0])
    delays = -np.dot(mic_pos - ref_pos, u) / c
    d = np.exp(-1j * 2 * np.pi * f * delays)
    
    # 超指向性权重
    Gamma_inv_d = np.linalg.solve(Gamma_reg, d)
    w = Gamma_inv_d / np.dot(d.conj(), Gamma_inv_d)
    
    return w

def compute_metrics(w, d, Gamma):
    """计算性能指标"""
    # 指向性因子
    DF = np.abs(np.dot(w.conj(), d))**2 / np.real(np.dot(w.conj(), Gamma @ w))
    
    # 白噪声增益
    WNG = np.abs(np.dot(w.conj(), d))**2 / np.dot(w.conj(), w)
    
    return 10*np.log10(DF), 10*np.log10(WNG)
```

### 7.2 应用场景

**助听器**：
- 2-3个麦克风
- 小间距（1-2 cm）
- 低频增强
- 需要鲁棒设计

**手机**：
- 2个麦克风
- 差分阵列
- 噪声抑制
- 心形指向性

**专业录音**：
- 高端麦克风
- 精确校准
- 低噪声环境
- 追求最大指向性

---

## 8. 优缺点总结

### 8.1 优点

1. **高指向性**：小阵列实现窄主瓣
2. **低频性能好**：在 $D \ll \lambda$ 时优于DS
3. **理论最优**：最大化指向性因子

### 8.2 缺点

1. **WNG低**：可能放大传感器噪声
2. **鲁棒性差**：对阵列误差敏感
3. **频率依赖**：需要频率依赖权重
4. **计算复杂**：需要矩阵求逆

### 8.3 适用条件

- 小阵列（$D < \lambda$）
- 低噪声环境
- 精确校准的阵列
- 扩散噪声场
