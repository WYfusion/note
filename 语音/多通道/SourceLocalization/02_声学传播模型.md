# 声学传播模型

## 1. 概述

声学传播模型描述声波从声源到麦克风的传播过程，包括直达声、反射、衰减等物理现象。准确的传播模型是声源定位的基础。

---

## 2. 自由场传播

### 2.1 球面波模型

在自由空间中，点声源产生**球面波**：

$$p(r, t) = \frac{A}{r}s\left(t - \frac{r}{c}\right)$$

其中：
- $p(r, t)$：距离$r$处的声压
- $A$：源强度
- $s(t)$：源信号
- $c$：声速
- $r$：距离

**能量衰减**：

$$|p(r)| \propto \frac{1}{r}$$

功率衰减：

$$|p(r)|^2 \propto \frac{1}{r^2}$$

**dB表示**：

$$L(r) = L_0 - 20\log_{10}\left(\frac{r}{r_0}\right)$$

距离加倍，声压级下降6 dB。

### 2.2 平面波近似

当 $r \gg \lambda$ 且观测区域远小于$r$时，球面波可近似为**平面波**：

$$p(\mathbf{r}, t) \approx A \cdot s\left(t - \frac{\mathbf{u}^T\mathbf{r}}{c}\right)$$

其中 $\mathbf{u}$ 是传播方向单位矢量。

**条件**：

$$r > \frac{2D^2}{\lambda}$$

$D$ 是观测区域尺寸（阵列孔径）。

### 2.3 频域表示

**球面波**：

$$P(r, \omega) = \frac{A}{r}S(\omega)e^{-j\omega r/c}$$

**平面波**：

$$P(\mathbf{r}, \omega) = A \cdot S(\omega)e^{-j\omega \mathbf{u}^T\mathbf{r}/c}$$

---

## 3. 声速与环境

### 3.1 声速公式

**理想气体中的声速**：

$$c = \sqrt{\gamma \frac{RT}{M}}$$

其中：
- $\gamma = 1.4$：比热比（空气）
- $R = 8.314$ J/(mol·K)：气体常数
- $T$：绝对温度（K）
- $M = 0.029$ kg/mol：空气摩尔质量

**简化公式**（空气，温度$T$°C）：

$$c \approx 331.3 + 0.606T \text{ m/s}$$

**示例**：
- 0°C：$c = 331.3$ m/s
- 20°C：$c = 343.4$ m/s
- 30°C：$c = 349.5$ m/s

### 3.2 环境因素

**湿度影响**：

湿度增加，声速略微增加（<1%）。

**气压影响**：

标准大气压下，气压变化对声速影响很小。

**风速影响**：

有效声速：

$$c_{\text{eff}} = c + \mathbf{v}_{\text{wind}}^T\mathbf{u}$$

其中 $\mathbf{v}_{\text{wind}}$ 是风速矢量。

---

## 4. 吸收与衰减

### 4.1 大气吸收

声波在空气中传播会被吸收，导致额外衰减：

$$p(r) = \frac{A}{r}e^{-\alpha r}$$

**吸收系数** $\alpha$（dB/m）：

$$\alpha = \alpha_0 f^2$$

其中 $\alpha_0$ 依赖于温度和湿度。

**典型值**（20°C，50%湿度）：
- 1 kHz：$\alpha \approx 0.001$ dB/m
- 10 kHz：$\alpha \approx 0.1$ dB/m

**总衰减**：

$$L(r) = L_0 - 20\log_{10}(r) - \alpha r$$

### 4.2 地面效应

声波在地面附近传播时，会受到地面反射和吸收的影响。

**有效衰减**：

$$L(r) \approx L_0 - (20 + \beta)\log_{10}(r)$$

其中 $\beta$ 取决于地面类型（0-10）。

---

## 5. 房间声学

### 5.1 房间脉冲响应 (RIR)

房间中的声学传播可以用**房间脉冲响应**描述：

$$x(t) = h(t) * s(t) = \int_{-\infty}^{\infty} h(\tau)s(t-\tau)d\tau$$

其中：
- $h(t)$：房间脉冲响应
- $s(t)$：源信号
- $x(t)$：接收信号

**RIR结构**：

```
|h(t)|
  ↑
  |  直达声
  |   ↓
  |   █
  |     早期反射
  |      ↓
  |      █ █ █
  |           晚期混响
  |            ↓
  |            ▓▓▓▓▓▓▓▓▓▓
  └────────────────────→ t
  0   T_d  T_50      T_60
```

**三个部分**：
1. **直达声**：$t = r/c$
2. **早期反射**：$t < 50$ ms
3. **晚期混响**：$t > 50$ ms

### 5.2 混响时间

**定义**：声源停止后，声压级衰减60 dB所需的时间。

**Sabine公式**：

$$T_{60} = \frac{0.161V}{A}$$

其中：
- $V$：房间体积（m³）
- $A = \sum_i \alpha_i S_i$：总吸声量
- $\alpha_i$：表面$i$的吸声系数
- $S_i$：表面$i$的面积（m²）

**Eyring公式**（更准确）：

$$T_{60} = \frac{0.161V}{-S\ln(1-\bar{\alpha})}$$

其中 $\bar{\alpha}$ 是平均吸声系数。

**典型值**：
- 起居室：$T_{60} \approx 0.3-0.5$ s
- 办公室：$T_{60} \approx 0.5-0.8$ s
- 音乐厅：$T_{60} \approx 1.5-2.5$ s

### 5.3 镜像源模型

**原理**：将墙壁反射建模为虚拟的镜像源。

**一阶反射**（6个墙面）：

$$h_1(t) = \sum_{i=1}^{6} \frac{\beta_i A}{r_i}\delta\left(t - \frac{r_i}{c}\right)$$

其中：
- $\beta_i$：墙面$i$的反射系数
- $r_i$：镜像源到接收点的距离

**高阶反射**：

递归计算镜像源的镜像源。

**总RIR**：

$$h(t) = h_{\text{direct}}(t) + h_1(t) + h_2(t) + \cdots$$

### 5.4 统计混响模型

**Polack模型**：

晚期混响可以建模为指数衰减的高斯噪声：

$$h(t) = \mathcal{N}(0, \sigma^2(t))$$

其中：

$$\sigma^2(t) = \sigma_0^2 e^{-6.91t/T_{60}}$$

---

## 6. 多径传播

### 6.1 多径模型

接收信号是多条路径的叠加：

$$x(t) = \sum_{k=1}^{K} \alpha_k s(t - \tau_k) + n(t)$$

其中：
- $K$：路径数量
- $\alpha_k$：第$k$条路径的衰减
- $\tau_k$：第$k$条路径的时延

**频域**：

$$X(\omega) = S(\omega)\sum_{k=1}^{K} \alpha_k e^{-j\omega\tau_k} + N(\omega)$$

### 6.2 相干性

**时间相干性**：

相干时间：

$$T_c \approx \frac{1}{\Delta f}$$

其中 $\Delta f$ 是多普勒扩展。

**空间相干性**：

相干距离：

$$d_c \approx \frac{\lambda}{2}$$

麦克风间距小于 $d_c$ 时，信号高度相关。

### 6.3 对定位的影响

**TDOA估计误差**：

多径导致互相关函数出现多个峰值：

$$R_{ij}(\tau) = \sum_{k,l} \alpha_k\alpha_l R_s(\tau - (\tau_{ik} - \tau_{jl}))$$

**解决方法**：
1. 选择最强峰（直达声）
2. 使用相位变换（PHAT）抑制混响
3. 短时窗处理
4. 深度学习去混响

---

## 7. 近场与远场

### 7.1 近场区域

**定义**：

$$r < \frac{2D^2}{\lambda}$$

**特点**：
- 球面波曲率明显
- 不同麦克风的到达角不同
- 可以估计距离

**TDOA模型**：

$$\tau_{ij} = \frac{1}{c}\left(\|\mathbf{r}_s - \mathbf{r}_i\| - \|\mathbf{r}_s - \mathbf{r}_j\|\right)$$

### 7.2 远场区域

**定义**：

$$r > \frac{2D^2}{\lambda}$$

**特点**：
- 平面波近似
- 所有麦克风的到达角相同
- 只能估计方向，不能估计距离

**TDOA模型**：

$$\tau_{ij} \approx \frac{1}{c}\mathbf{u}^T(\mathbf{r}_i - \mathbf{r}_j)$$

### 7.3 过渡区域

在近场和远场之间，需要考虑二阶项：

$$\tau_{ij} \approx \frac{1}{c}\mathbf{u}^T\mathbf{d}_{ij} + \frac{1}{2cr}\mathbf{d}_{ij}^T(\mathbf{I} - \mathbf{u}\mathbf{u}^T)\mathbf{d}_{ij}$$

第一项：远场（方向）
第二项：近场修正（距离）

---

## 8. 噪声模型

### 8.1 传感器噪声

**加性白高斯噪声 (AWGN)**：

$$x_i(t) = s_i(t) + n_i(t)$$

其中 $n_i(t) \sim \mathcal{N}(0, \sigma_n^2)$。

**信噪比 (SNR)**：

$$\text{SNR} = 10\log_{10}\frac{P_s}{P_n}$$

### 8.2 环境噪声

**扩散噪声场**：

各向同性的环境噪声，空间协方差：

$$\mathbb{E}[N_i(\omega)N_j^*(\omega)] = \sigma_n^2(\omega)\text{sinc}\left(\frac{\omega d_{ij}}{c}\right)$$

其中 $d_{ij} = \|\mathbf{r}_i - \mathbf{r}_j\|$。

**相干噪声**：

来自特定方向的干扰：

$$\mathbf{n}(t) = \mathbf{d}(\theta_n)n(t)$$

### 8.3 量化噪声

**ADC量化**：

量化噪声功率：

$$\sigma_q^2 = \frac{\Delta^2}{12}$$

其中 $\Delta$ 是量化步长。

**有效位数 (ENOB)**：

$$\text{ENOB} = \frac{\text{SINAD} - 1.76}{6.02}$$

---

## 9. 仿真模型

### 9.1 pyroomacoustics

Python库，用于房间声学仿真：

```python
import pyroomacoustics as pra
import numpy as np

# 创建房间
room_dim = [5, 4, 3]  # 长x宽x高 (m)
room = pra.ShoeBox(
    room_dim, 
    fs=16000, 
    materials=pra.Material(0.2),  # 吸声系数
    max_order=3  # 最大反射阶数
)

# 添加声源
source_pos = [2.5, 2, 1.5]
room.add_source(source_pos)

# 添加麦克风阵列
mic_array = np.array([
    [1, 1, 1],
    [1.1, 1, 1],
    [1.05, 1.087, 1]
]).T
room.add_microphone_array(mic_array)

# 计算RIR
room.compute_rir()

# 获取RIR
rir = room.rir[0][0]  # 第一个麦克风，第一个源

# 仿真信号
signal = np.random.randn(16000)  # 1秒信号
room.simulate()
recorded = room.mic_array.signals
```

### 9.2 镜像源法实现

```python
def image_source_method(room_dim, source_pos, mic_pos, 
                        max_order=3, reflection_coef=0.7, fs=16000, c=343):
    """
    镜像源法计算RIR
    
    参数:
        room_dim: [L, W, H] - 房间尺寸
        source_pos: [x, y, z] - 声源位置
        mic_pos: [x, y, z] - 麦克风位置
        max_order: 最大反射阶数
        reflection_coef: 反射系数
        fs: 采样率
        c: 声速
    """
    L, W, H = room_dim
    xs, ys, zs = source_pos
    xm, ym, zm = mic_pos
    
    # 计算最大时延
    max_dist = np.linalg.norm(np.array(room_dim)) * (2 * max_order + 1)
    max_time = max_dist / c
    n_samples = int(max_time * fs) + 1
    
    rir = np.zeros(n_samples)
    
    # 遍历所有镜像源
    for nx in range(-max_order, max_order + 1):
        for ny in range(-max_order, max_order + 1):
            for nz in range(-max_order, max_order + 1):
                # 镜像源位置
                if nx % 2 == 0:
                    x_img = xs + 2 * nx * L
                else:
                    x_img = 2 * (nx + 1) * L - xs
                
                if ny % 2 == 0:
                    y_img = ys + 2 * ny * W
                else:
                    y_img = 2 * (ny + 1) * W - ys
                
                if nz % 2 == 0:
                    z_img = zs + 2 * nz * H
                else:
                    z_img = 2 * (nz + 1) * H - zs
                
                # 距离和时延
                dist = np.sqrt(
                    (x_img - xm)**2 + 
                    (y_img - ym)**2 + 
                    (z_img - zm)**2
                )
                delay = dist / c
                
                # 反射次数
                order = abs(nx) + abs(ny) + abs(nz)
                if order > max_order:
                    continue
                
                # 衰减
                amplitude = reflection_coef**order / dist
                
                # 添加到RIR
                sample_idx = int(delay * fs)
                if sample_idx < n_samples:
                    rir[sample_idx] += amplitude
    
    return rir
```

---

## 10. 实际考虑

### 10.1 温度补偿

实时测量温度并调整声速：

```python
def adjust_speed_of_sound(temperature_celsius):
    """根据温度调整声速"""
    return 331.3 + 0.606 * temperature_celsius
```

### 10.2 混响抑制

**方法**：
1. **相位变换 (PHAT)**：抑制混响影响
2. **短时窗**：只使用直达声
3. **自适应滤波**：估计并去除混响
4. **深度学习**：端到端去混响

### 10.3 多径鲁棒性

**策略**：
1. 选择最强峰（假设为直达声）
2. 使用多个频率联合估计
3. 时频掩码去除混响主导的时频点
4. 基于模型的混响补偿

---

## 11. 总结

声学传播模型的关键要点：

1. **自由场**：球面波，$1/r$ 衰减
2. **远场近似**：平面波，简化计算
3. **房间声学**：直达声 + 反射 + 混响
4. **多径传播**：影响TDOA估计
5. **噪声**：传感器噪声 + 环境噪声

**实际应用**：
- 自由场：户外定位
- 房间：室内定位（主要场景）
- 需要考虑混响和多径
- 温度补偿提高精度
