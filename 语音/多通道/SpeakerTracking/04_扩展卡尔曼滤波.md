# 扩展卡尔曼滤波

## 1. 概述

**扩展卡尔曼滤波 (Extended Kalman Filter, EKF)** 通过线性化处理非线性系统，是KF在非线性情况下的扩展。

---

## 2. 非线性系统模型

**状态方程**：
$$\mathbf{x}_t = f(\mathbf{x}_{t-1}, \mathbf{u}_t) + \mathbf{w}_t$$

**观测方程**：
$$\mathbf{z}_t = h(\mathbf{x}_t) + \mathbf{v}_t$$

---

## 3. 线性化方法

### 3.1 一阶泰勒展开

**状态转移线性化**：
$$f(\mathbf{x}_{t-1}) \approx f(\hat{\mathbf{x}}_{t-1}) + \mathbf{F}_t (\mathbf{x}_{t-1} - \hat{\mathbf{x}}_{t-1})$$

其中雅可比矩阵：
$$\mathbf{F}_t = \frac{\partial f}{\partial \mathbf{x}}\bigg|_{\mathbf{x}=\hat{\mathbf{x}}_{t-1}}$$

**观测线性化**：
$$h(\mathbf{x}_t) \approx h(\hat{\mathbf{x}}_{t|t-1}) + \mathbf{H}_t (\mathbf{x}_t - \hat{\mathbf{x}}_{t|t-1})$$

其中：
$$\mathbf{H}_t = \frac{\partial h}{\partial \mathbf{x}}\bigg|_{\mathbf{x}=\hat{\mathbf{x}}_{t|t-1}}$$

---

## 4. EKF算法

### 4.1 预测

$$\hat{\mathbf{x}}_{t|t-1} = f(\hat{\mathbf{x}}_{t-1|t-1}, \mathbf{u}_t)$$

$$\mathbf{P}_{t|t-1} = \mathbf{F}_t \mathbf{P}_{t-1|t-1} \mathbf{F}_t^T + \mathbf{Q}_t$$

### 4.2 更新

$$\mathbf{K}_t = \mathbf{P}_{t|t-1} \mathbf{H}_t^T (\mathbf{H}_t \mathbf{P}_{t|t-1} \mathbf{H}_t^T + \mathbf{R}_t)^{-1}$$

$$\hat{\mathbf{x}}_{t|t} = \hat{\mathbf{x}}_{t|t-1} + \mathbf{K}_t (\mathbf{z}_t - h(\hat{\mathbf{x}}_{t|t-1}))$$

$$\mathbf{P}_{t|t} = (\mathbf{I} - \mathbf{K}_t \mathbf{H}_t) \mathbf{P}_{t|t-1}$$

---

## 5. 说话人追踪应用

### 5.1 DOA观测模型

**观测函数**：
$$h(\mathbf{x}) = \arctan\left(\frac{y - y_0}{x - x_0}\right)$$

**雅可比矩阵**：
$$\mathbf{H} = \begin{bmatrix} \frac{-(y-y_0)}{r^2} & \frac{x-x_0}{r^2} & 0 & 0 \end{bmatrix}$$

其中 $r^2 = (x-x_0)^2 + (y-y_0)^2$

### 5.2 实现

```python
import numpy as np

class ExtendedKalmanFilter:
    """扩展卡尔曼滤波器"""
    
    def __init__(self, f, h, F_jacobian, H_jacobian, Q, R, x0, P0):
        self.f = f  # 状态转移函数
        self.h = h  # 观测函数
        self.F_jacobian = F_jacobian  # 状态雅可比
        self.H_jacobian = H_jacobian  # 观测雅可比
        self.Q = Q
        self.R = R
        self.x = x0
        self.P = P0
    
    def predict(self):
        # 非线性状态预测
        self.x = self.f(self.x)
        
        # 计算雅可比
        F = self.F_jacobian(self.x)
        
        # 协方差预测
        self.P = F @ self.P @ F.T + self.Q
        
        return self.x, self.P
    
    def update(self, z):
        # 计算观测雅可比
        H = self.H_jacobian(self.x)
        
        # 预测观测
        z_pred = self.h(self.x)
        
        # 创新
        y = z - z_pred
        
        # 创新协方差
        S = H @ self.P @ H.T + self.R
        
        # 卡尔曼增益
        K = self.P @ H.T @ np.linalg.inv(S)
        
        # 状态更新
        self.x = self.x + K @ y
        
        # 协方差更新
        self.P = (np.eye(len(self.x)) - K @ H) @ self.P
        
        return self.x, self.P
```

---

## 6. 优缺点

**优点**：
- 处理非线性系统
- 计算相对简单
- 广泛应用

**缺点**：
- 线性化误差
- 可能发散
- 需要计算雅可比矩阵

---

## 参考文献

1. Jazwinski, A. H. (1970). "Stochastic Processes and Filtering Theory."

2. Bar-Shalom, Y., et al. (2001). "Estimation with Applications to Tracking and Navigation."
