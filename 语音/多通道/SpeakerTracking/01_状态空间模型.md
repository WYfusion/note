# 状态空间模型

## 1. 概述

**状态空间模型 (State Space Model)** 是描述动态系统的数学框架，是说话人追踪的理论基础。

### 1.1 基本概念

**状态**：系统在时刻 $t$ 的完整描述
**观测**：对状态的不完全、带噪声的测量
**动态**：状态随时间的演化规律

---

## 2. 数学模型

### 2.1 状态方程

**离散时间状态方程**：

$$\mathbf{x}_t = f_t(\mathbf{x}_{t-1}, \mathbf{u}_t, \mathbf{w}_t)$$

其中：
- $\mathbf{x}_t \in \mathbb{R}^{n_x}$：时刻 $t$ 的状态向量
- $f_t$：状态转移函数
- $\mathbf{u}_t$：控制输入（可选）
- $\mathbf{w}_t \sim p(\mathbf{w})$：过程噪声

**线性形式**：

$$\mathbf{x}_t = \mathbf{F}_t \mathbf{x}_{t-1} + \mathbf{B}_t \mathbf{u}_t + \mathbf{w}_t$$

其中：
- $\mathbf{F}_t \in \mathbb{R}^{n_x \times n_x}$：状态转移矩阵
- $\mathbf{B}_t \in \mathbb{R}^{n_x \times n_u}$：控制输入矩阵

### 2.2 观测方程

**观测方程**：

$$\mathbf{z}_t = h_t(\mathbf{x}_t, \mathbf{v}_t)$$

其中：
- $\mathbf{z}_t \in \mathbb{R}^{n_z}$：观测向量
- $h_t$：观测函数
- $\mathbf{v}_t \sim p(\mathbf{v})$：观测噪声

**线性形式**：

$$\mathbf{z}_t = \mathbf{H}_t \mathbf{x}_t + \mathbf{v}_t$$

其中 $\mathbf{H}_t \in \mathbb{R}^{n_z \times n_x}$ 是观测矩阵。

### 2.3 噪声假设

**高斯噪声**：

$$\mathbf{w}_t \sim \mathcal{N}(\mathbf{0}, \mathbf{Q}_t)$$
$$\mathbf{v}_t \sim \mathcal{N}(\mathbf{0}, \mathbf{R}_t)$$

其中：
- $\mathbf{Q}_t$：过程噪声协方差矩阵
- $\mathbf{R}_t$：观测噪声协方差矩阵

**独立性假设**：
- $\mathbf{w}_t$ 和 $\mathbf{v}_t$ 相互独立
- 不同时刻的噪声相互独立

---

## 3. 说话人追踪的状态表示

### 3.1 位置-速度模型

**状态向量**：

$$\mathbf{x}_t = \begin{bmatrix} x_t \\ y_t \\ \dot{x}_t \\ \dot{y}_t \end{bmatrix}$$

其中：
- $(x_t, y_t)$：说话人位置
- $(\dot{x}_t, \dot{y}_t)$：速度

**3D扩展**：

$$\mathbf{x}_t = \begin{bmatrix} x_t \\ y_t \\ z_t \\ \dot{x}_t \\ \dot{y}_t \\ \dot{z}_t \end{bmatrix}$$

### 3.2 位置-速度-加速度模型

**状态向量**：

$$\mathbf{x}_t = \begin{bmatrix} x_t \\ y_t \\ \dot{x}_t \\ \dot{y}_t \\ \ddot{x}_t \\ \ddot{y}_t \end{bmatrix}$$

适用于加速运动场景。

### 3.3 角度表示

**方位角-俯仰角模型**：

$$\mathbf{x}_t = \begin{bmatrix} \theta_t \\ \phi_t \\ \dot{\theta}_t \\ \dot{\phi}_t \end{bmatrix}$$

其中：
- $\theta_t$：方位角
- $\phi_t$：俯仰角

---

## 4. 运动模型

### 4.1 匀速运动模型 (CV)

**状态转移**：

$$\begin{bmatrix} x_t \\ y_t \\ \dot{x}_t \\ \dot{y}_t \end{bmatrix} = \begin{bmatrix} 1 & 0 & \Delta t & 0 \\ 0 & 1 & 0 & \Delta t \\ 0 & 0 & 1 & 0 \\ 0 & 0 & 0 & 1 \end{bmatrix} \begin{bmatrix} x_{t-1} \\ y_{t-1} \\ \dot{x}_{t-1} \\ \dot{y}_{t-1} \end{bmatrix} + \mathbf{w}_t$$

**过程噪声**：

$$\mathbf{Q} = q \begin{bmatrix} \frac{\Delta t^3}{3} & 0 & \frac{\Delta t^2}{2} & 0 \\ 0 & \frac{\Delta t^3}{3} & 0 & \frac{\Delta t^2}{2} \\ \frac{\Delta t^2}{2} & 0 & \Delta t & 0 \\ 0 & \frac{\Delta t^2}{2} & 0 & \Delta t \end{bmatrix}$$

其中 $q$ 是过程噪声强度。

### 4.2 匀加速运动模型 (CA)

**状态转移矩阵**：

$$\mathbf{F} = \begin{bmatrix} 1 & 0 & \Delta t & 0 & \frac{\Delta t^2}{2} & 0 \\ 0 & 1 & 0 & \Delta t & 0 & \frac{\Delta t^2}{2} \\ 0 & 0 & 1 & 0 & \Delta t & 0 \\ 0 & 0 & 0 & 1 & 0 & \Delta t \\ 0 & 0 & 0 & 0 & 1 & 0 \\ 0 & 0 & 0 & 0 & 0 & 1 \end{bmatrix}$$

### 4.3 协调转弯模型 (CT)

**非线性状态转移**：

$$\begin{bmatrix} x_t \\ y_t \\ \dot{x}_t \\ \dot{y}_t \\ \omega_t \end{bmatrix} = \begin{bmatrix} x_{t-1} + \frac{\dot{x}_{t-1}}{\omega_{t-1}}(\sin(\omega_{t-1}\Delta t)) - \frac{\dot{y}_{t-1}}{\omega_{t-1}}(1-\cos(\omega_{t-1}\Delta t)) \\ y_{t-1} + \frac{\dot{x}_{t-1}}{\omega_{t-1}}(1-\cos(\omega_{t-1}\Delta t)) + \frac{\dot{y}_{t-1}}{\omega_{t-1}}(\sin(\omega_{t-1}\Delta t)) \\ \dot{x}_{t-1}\cos(\omega_{t-1}\Delta t) - \dot{y}_{t-1}\sin(\omega_{t-1}\Delta t) \\ \dot{x}_{t-1}\sin(\omega_{t-1}\Delta t) + \dot{y}_{t-1}\cos(\omega_{t-1}\Delta t) \\ \omega_{t-1} \end{bmatrix}$$

其中 $\omega_t$ 是转弯角速度。

### 4.4 随机游走模型

**简单随机游走**：

$$\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t$$

适用于运动模式未知的场景。

---

## 5. 观测模型

### 5.1 笛卡尔坐标观测

**直接位置观测**：

$$\mathbf{z}_t = \begin{bmatrix} x_t \\ y_t \end{bmatrix} + \mathbf{v}_t$$

$$\mathbf{H} = \begin{bmatrix} 1 & 0 & 0 & 0 \\ 0 & 1 & 0 & 0 \end{bmatrix}$$

### 5.2 极坐标观测

**距离-方位角观测**：

$$\mathbf{z}_t = \begin{bmatrix} r_t \\ \theta_t \end{bmatrix} = \begin{bmatrix} \sqrt{x_t^2 + y_t^2} \\ \arctan(y_t/x_t) \end{bmatrix} + \mathbf{v}_t$$

**非线性观测函数**：

$$h(\mathbf{x}_t) = \begin{bmatrix} \sqrt{x_t^2 + y_t^2} \\ \arctan(y_t/x_t) \end{bmatrix}$$

### 5.3 DOA观测

**方位角观测**：

$$z_t = \theta_t = \arctan\left(\frac{y_t - y_{\text{array}}}{x_t - x_{\text{array}}}\right) + v_t$$

其中 $(x_{\text{array}}, y_{\text{array}})$ 是麦克风阵列位置。

### 5.4 TDOA观测

**时延差观测**：

$$\tau_{ij}(t) = \frac{1}{c}\left(\|\mathbf{p}_t - \mathbf{m}_i\| - \|\mathbf{p}_t - \mathbf{m}_j\|\right) + v_t$$

其中：
- $\mathbf{p}_t$：说话人位置
- $\mathbf{m}_i, \mathbf{m}_j$：麦克风位置
- $c$：声速

---

## 6. 模型参数设计

### 6.1 过程噪声协方差

**经验设置**：

$$q = \sigma_a^2$$

其中 $\sigma_a$ 是加速度标准差，典型值：
- 慢速运动：$\sigma_a = 0.1$ m/s²
- 正常运动：$\sigma_a = 0.5$ m/s²
- 快速运动：$\sigma_a = 1.0$ m/s²

### 6.2 观测噪声协方差

**DOA观测**：

$$R_{\theta} = \sigma_{\theta}^2$$

典型值：$\sigma_{\theta} = 1°$ - $5°$

**TDOA观测**：

$$R_{\tau} = \sigma_{\tau}^2$$

典型值：$\sigma_{\tau} = 0.1$ - $1.0$ ms

### 6.3 初始状态不确定性

**初始协方差矩阵**：

$$\mathbf{P}_0 = \begin{bmatrix} \sigma_x^2 & 0 & 0 & 0 \\ 0 & \sigma_y^2 & 0 & 0 \\ 0 & 0 & \sigma_{\dot{x}}^2 & 0 \\ 0 & 0 & 0 & \sigma_{\dot{y}}^2 \end{bmatrix}$$

---

## 7. 模型选择

### 7.1 模型对比

| 模型 | 状态维度 | 适用场景 | 计算复杂度 |
|------|----------|----------|------------|
| CV | 4 | 匀速直线 | 低 |
| CA | 6 | 加速运动 | 中 |
| CT | 5 | 转弯运动 | 高 |
| 随机游走 | 2 | 未知模式 | 低 |

### 7.2 自适应模型切换

**交互式多模型 (IMM)**：

同时运行多个模型，根据似然加权融合：

$$\hat{\mathbf{x}}_t = \sum_{i=1}^{M} \mu_i^t \hat{\mathbf{x}}_t^{(i)}$$

其中 $\mu_i^t$ 是模型 $i$ 的概率。

---

## 8. 实现示例

```python
import numpy as np

class StateSpaceModel:
    """状态空间模型基类"""
    
    def __init__(self, dt=0.1):
        """
        参数:
            dt: 采样时间间隔
        """
        self.dt = dt
        
    def predict(self, x, P):
        """
        预测步骤
        
        参数:
            x: 当前状态估计
            P: 当前协方差矩阵
        
        返回:
            x_pred: 预测状态
            P_pred: 预测协方差
        """
        raise NotImplementedError
    
    def update(self, x_pred, P_pred, z):
        """
        更新步骤
        
        参数:
            x_pred: 预测状态
            P_pred: 预测协方差
            z: 观测值
        
        返回:
            x_est: 更新后的状态估计
            P_est: 更新后的协方差
        """
        raise NotImplementedError


class CVModel(StateSpaceModel):
    """匀速运动模型"""
    
    def __init__(self, dt=0.1, q=0.1):
        super().__init__(dt)
        self.q = q
        
        # 状态转移矩阵
        self.F = np.array([
            [1, 0, dt, 0],
            [0, 1, 0, dt],
            [0, 0, 1, 0],
            [0, 0, 0, 1]
        ])
        
        # 过程噪声协方差
        self.Q = q * np.array([
            [dt**3/3, 0, dt**2/2, 0],
            [0, dt**3/3, 0, dt**2/2],
            [dt**2/2, 0, dt, 0],
            [0, dt**2/2, 0, dt]
        ])
    
    def predict(self, x, P):
        """预测步骤"""
        x_pred = self.F @ x
        P_pred = self.F @ P @ self.F.T + self.Q
        return x_pred, P_pred


class DOAObservationModel:
    """DOA观测模型"""
    
    def __init__(self, array_pos, sigma_theta=np.deg2rad(2)):
        """
        参数:
            array_pos: 阵列位置 [x, y]
            sigma_theta: 角度测量标准差（弧度）
        """
        self.array_pos = np.array(array_pos)
        self.R = sigma_theta**2
    
    def observe(self, x):
        """
        观测函数
        
        参数:
            x: 状态向量 [x, y, vx, vy]
        
        返回:
            z: 观测值（方位角）
        """
        dx = x[0] - self.array_pos[0]
        dy = x[1] - self.array_pos[1]
        theta = np.arctan2(dy, dx)
        return theta
    
    def jacobian(self, x):
        """
        观测函数的雅可比矩阵
        
        返回:
            H: 雅可比矩阵
        """
        dx = x[0] - self.array_pos[0]
        dy = x[1] - self.array_pos[1]
        r2 = dx**2 + dy**2
        
        H = np.array([[-dy/r2, dx/r2, 0, 0]])
        return H


# 使用示例
def example_state_space():
    """状态空间模型使用示例"""
    
    # 创建匀速运动模型
    motion_model = CVModel(dt=0.1, q=0.1)
    
    # 创建DOA观测模型
    obs_model = DOAObservationModel(array_pos=[0, 0], sigma_theta=np.deg2rad(2))
    
    # 初始状态
    x = np.array([5.0, 3.0, 0.5, 0.3])  # [x, y, vx, vy]
    P = np.diag([1.0, 1.0, 0.5, 0.5])
    
    # 预测
    x_pred, P_pred = motion_model.predict(x, P)
    print(f"预测状态: {x_pred}")
    print(f"预测协方差对角线: {np.diag(P_pred)}")
    
    # 观测
    z = obs_model.observe(x_pred)
    print(f"观测角度: {np.rad2deg(z):.2f}°")
    
    # 雅可比矩阵
    H = obs_model.jacobian(x_pred)
    print(f"观测雅可比: {H}")

# example_state_space()
```

---

## 9. 总结

### 9.1 关键要点

1. **状态表示**：选择合适的状态向量
2. **运动模型**：根据运动特性选择模型
3. **观测模型**：根据传感器类型设计
4. **参数调优**：合理设置噪声协方差

### 9.2 设计原则

- **简洁性**：状态维度尽可能低
- **准确性**：模型符合实际运动
- **鲁棒性**：对参数不敏感
- **计算效率**：实时处理要求

---

## 参考文献

1. Bar-Shalom, Y., et al. (2001). "Estimation with Applications to Tracking and Navigation." Wiley.

2. Ristic, B., et al. (2004). "Beyond the Kalman Filter: Particle Filters for Tracking Applications." Artech House.

3. Gustafsson, F. (2010). "Statistical Sensor Fusion." Studentlitteratur.
