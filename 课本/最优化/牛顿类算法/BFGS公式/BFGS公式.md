![[Pasted image 20250610143427.png|800]]
![[Pasted image 20250610143436.png|800]]
![[Pasted image 20250610143450.png|800]]

### BFGS的有效性
![[Pasted image 20250610143514.png|800]]


### BFGS公式详解

BFGS算法是一种拟牛顿法，广泛应用于无约束优化问题中。其核心思想是通过迭代更新近似Hessian矩阵（或其逆矩阵），来逼近真实的Hessian矩阵，从而避免直接计算复杂的二阶导数信息。下面将详细解释BFGS公式的推导过程、关键部分的证明，并确保逻辑严谨、可读性强。

#### 一、BFGS公式的核心思想：秩二更新
BFGS算法的核心在于对当前近似Hessian矩阵$B^k$进行秩二更新，以得到新的近似Hessian矩阵$B^{k+1}$。秩二更新的定义如下：
对于拟牛顿矩阵$B^k \in \mathbb{R}^{n \times n}$，设$0 \neq u, v \in \mathbb{R}^n$且$a, b \in \mathbb{R}$待定，秩二更新形式为：
$$B^{k+1} = B^k + a u u^T + b v v^T$$
其中，$u$和$v$是更新方向，$a$和$b$是更新步长。这种更新方式只改变$B^k$的秩为2的子空间，因此称为秩二更新。
#### 二、秩二更新公式的推导
为了确定$a$、$b$、$u$和$v$的取值，我们需要利用割线方程。割线方程是拟牛顿法的基本条件，它要求近似Hessian矩阵的更新满足：
$$B^{k+1} s^k = y^k$$
其中，$s^k = x^{k+1} - x^k$是迭代步长，$y^k = \nabla f(x^{k+1}) - \nabla f(x^k)$是梯度差。
将秩二更新的表达式代入割线方程，我们得到：
$$(B^k + a u u^T + b v v^T) s^k = y^k$$
整理后可得：
$$a (u^T s^k) u + b (v^T s^k) v = y^k - B^k s^k$$
为了简化这个方程，我们可以采取一种简单的取法：令$a (u^T s^k) = 1$，$u = y^k$，以及$b (v^T s^k) = -1$，$v = B^k s^k$。
这样，我们可以解出 $a$ 和 $b$：
- $a = \frac{1}{u^T s^k} = \frac{1}{(y^k)^T s^k}$
- $b = \frac{-1}{v^T s^k} = \frac{-1}{(B^k s^k)^T s^k}$这样，将 $a$、$b$、$u$ 和 $v$ 的取值代入秩二更新公式，我们得到BFGS算法的更新公式：
$$B^{k+1} = B^k + \frac{y^k (y^k)^T}{(s^k)^T y^k} - \frac{B^k s^k (B^k s^k)^T}{(s^k)^T B^k s^k}$$
#### 三、基于$H^k$的BFGS公式
在实际应用中，我们更关心的是近似Hessian矩阵的逆矩阵$H^k = (B^k)^{-1}$。通过使用SMW（Sherman-Morrison-Woodbury）公式，我们可以从基于$B^k$的BFGS公式推导出基于$H^k$的BFGS公式。
SMW公式为：
$$(B + UV^T)^{-1} = B^{-1} - B^{-1}U(I + V^T B^{-1} U)^{-1} V^T B^{-1}$$
其中，$B$是可逆矩阵，$U$和$V$是任意矩阵。
对照BFGS的秩二更新公式，我们可以令$B = B^k$，$U = \begin{pmatrix} -\frac{B^k s^k}{(s^k)^T B^k s^k} & \frac{y^k}{(s^k)^T y^k} \end{pmatrix}$，$V = \begin{pmatrix} B^k s^k & y^k \end{pmatrix}$。通过计算，我们可以得到基于$H^k$的BFGS公式：
$$H^{k+1} = \left(I - \frac{s^k (y^k)^T}{(s^k)^T y^k}\right) H^k \left(I - \frac{y^k (s^k)^T}{(s^k)^T y^k}\right) + \frac{s^k (s^k)^T}{(s^k)^T y^k}$$
#### 四、BFGS公式的正定性证明
一个有效的拟牛顿算法要求近似Hessian矩阵保持正定性，以确保搜索方向是下降方向。下面我们证明BFGS公式产生的矩阵$B^{k+1}$和$H^{k+1}$保持正定性的充分条件。
**定理**：使用秩二更新公式从$B^k$或$H^k$更新$B^{k+1}$或$H^{k+1}$，拟牛顿矩阵正定的充分条件可以是：
1. $B^k$或$H^k$正定；
2. 满足曲率条件$(s^k)^T y^k > 0$，$\forall k \in \mathbb{N}^+$。
**证明**：我们只需分析基于$H^k$的BFGS公式即可。假设$H^k$正定，且$(s^k)^T y^k > 0$。我们可以将$H^{k+1}$的表达式重写为：
$$H^{k+1} = H^k - \frac{H^k s^k (y^k)^T H^k}{(s^k)^T y^k} - \frac{y^k (s^k)^T H^k}{(s^k)^T y^k} + \frac{(s^k)^T y^k + (y^k)^T H^k y^k}{(s^k)^T y^k} \frac{s^k (s^k)^T}{(s^k)^T y^k}$$
经过化简，我们可以证明$H^{k+1}$仍然保持正定性。类似地，我们也可以证明$B^{k+1}$的正定性。
由于在使用Wolfe准则进行线搜索时，可以确保曲率条件$(s^k)^T y^k > 0$成立，因此BFGS算法产生的拟牛顿矩阵有望保持正定，从而确保算法的有效性。
综上所述，BFGS公式通过秩二更新方式迭代地更新近似Hessian矩阵或其逆矩阵，以满足割线方程，并保持矩阵的正定性。这使得BFGS算法成为一种高效且稳健的无约束优化算法。



### 一、牛顿法与 BFGS 的关系
想象你在爬山，目标是找到山谷最低点（函数最小值）。
- **牛顿法**：每一步都用二阶导数（函数弯曲程度）来预测下山方向，就像用 "望远镜" 看清远方地形，但计算二阶导数（海瑟矩阵）成本高，尤其在高维问题中。
- **BFGS**：不直接计算二阶导数，而是通过**历史步长**和**梯度变化**来近似二阶导数的逆，就像通过记录自己每步的移动和坡度变化来推断地形，节省了 "望远镜" 的成本。
### 二、BFGS 核心思想：用历史数据近似地形
假设你从 A 点走到 B 点：
1. **记录步长**（$s = B - A$）：走了多远。
2. **记录坡度变化**（$y = \nabla f(B) - \nabla f(A)$）：从 A 到 B，坡度（梯度）改变了多少。
3. **推断地形**：通过比较步长和坡度变化，推断函数的弯曲程度（海瑟矩阵的逆）。
例如：
- 若走了很长距离（s大）但坡度变化很小（y小），说明地形平坦（海瑟矩阵的逆大）。
- 若走了很短距离（s小）但坡度急剧变化（y大），说明地形陡峭（海瑟矩阵的逆小）。
### 三、BFGS 公式的直观理解
BFGS 公式可写成：$H_{\text{new}} = \left(I - \frac{s y^T}{y^T s}\right) H_{\text{old}} \left(I - \frac{y s^T}{y^T s}\right) + \frac{s s^T}{y^T s}$ **拆分成两部分理解**：
1. **第一部分**：$\left(I - \frac{s y^T}{y^T s}\right) H_{\text{old}} \left(I - \frac{y s^T}{y^T s}\right)$
    - 用当前步长 s 和坡度变化 y 修正旧的地形估计 $H_{\text{old}}$。
    - 类比：根据新走过的路，调整对地图的认知。
2. **第二部分**：$\frac{s s^T}{y^T s}$
    - 直接添加一个新的 "地形特征"，基于步长 s 和坡度变化 y 的比例。
    - 类比：在地图上标记新发现的重要地形（如陡坡或平地）。
### 四、为什么 BFGS 有效？
1. **节省计算成本**：避免直接计算海瑟矩阵，只需梯度（一阶导数）。
2. **保持收敛速度**：通过历史数据逐步逼近真实地形，收敛速度接近牛顿法。
3. **自适应调整**：每一步都结合新的步长和坡度变化，动态更新地形估计。
4. **处理高维问题**：在参数众多的问题（如机器学习）中表现优异，因为不需要存储或计算庞大的海瑟矩阵。
### 五、生活化比喻总结
假设你是盲人探险家，想找到山谷最低点：
- **牛顿法**：每次停下来用精密仪器测量地形全貌（二阶导数）。
- **BFGS**：边走边记录每一步的距离（s）和坡度变化（y），逐步构建对地形的认知。
    - 走了 10 米，坡度变缓 → 推断前方是缓坡。
    - 走了 1 米，坡度剧变 → 推断前方是陡坡。
    - 用这些信息更新脑海中的地图（$H_{\text{new}}$），指导下一步方向。